<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Real World Haskell Walk</title>
<!-- 2016-03-22 Tue 04:54 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Caio Rodrigues" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link href="/Functional-Programming/theme/style.css" rel="stylesheet">

<script type="text/javascript" src="/Functional-Programming/theme/org-info.js">
/**
 *
 * @source: /Functional-Programming/theme/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in /Functional-Programming/theme/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in /Functional-Programming/theme/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "4");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "overview");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Real World Haskell Walk</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Real World Haskell Codes</a>
<ul>
<li><a href="#sec-1-1">1.1. Overview</a></li>
<li><a href="#sec-1-2">1.2. Chapter 3  - Defining Types, Streamlining Functions</a>
<ul>
<li><a href="#sec-1-2-1">1.2.1. BookStore.hs</a></li>
<li><a href="#sec-1-2-2">1.2.2. BookStore2.hs</a></li>
<li><a href="#sec-1-2-3">1.2.3. AlgebraicVector.hs</a></li>
<li><a href="#sec-1-2-4">1.2.4. ShapeUnion.hs</a></li>
<li><a href="#sec-1-2-5">1.2.5. add.hs</a></li>
<li><a href="#sec-1-2-6">1.2.6. BookStore3.hs</a></li>
<li><a href="#sec-1-2-7">1.2.7. BookStore4.hs</a></li>
</ul>
</li>
<li><a href="#sec-1-3">1.3. Chapter 4  - Functional Programming</a>
<ul>
<li><a href="#sec-1-3-1">1.3.1. InteractWith.hs</a></li>
<li><a href="#sec-1-3-2">1.3.2. FixLines.hs</a></li>
<li><a href="#sec-1-3-3">1.3.3. ch4.exercises.hs</a></li>
<li><a href="#sec-1-3-4">1.3.4. IntParser.hs</a></li>
</ul>
</li>
<li><a href="#sec-1-4">1.4. Chapter 5  - Writing a Library: Working with JSON Data</a>
<ul>
<li><a href="#sec-1-4-1">1.4.1. SimpleJson1.hs</a></li>
<li><a href="#sec-1-4-2">1.4.2. SimpleJSon2.hs</a></li>
<li><a href="#sec-1-4-3">1.4.3. PutJSON.hs</a></li>
<li><a href="#sec-1-4-4">1.4.4. PrettyJSON.hs</a></li>
</ul>
</li>
<li><a href="#sec-1-5">1.5. Chapter 8  - Efficient File Processing, Regular Expressions, and Filename Matching</a>
<ul>
<li><a href="#sec-1-5-1">1.5.1. ElfMagic.hs</a></li>
<li><a href="#sec-1-5-2">1.5.2. HighestClose.hs</a></li>
</ul>
</li>
<li><a href="#sec-1-6">1.6. Chapter 10 - Code Case Study: Parsing a Binary Data Format</a>
<ul>
<li><a href="#sec-1-6-1">1.6.1. PNM.hs</a></li>
<li><a href="#sec-1-6-2">1.6.2. Parse.hs</a></li>
<li><a href="#sec-1-6-3">1.6.3. TreeMap.sh</a></li>
</ul>
</li>
<li><a href="#sec-1-7">1.7. Chapter 13 - Data Structures</a>
<ul>
<li><a href="#sec-1-7-1">1.7.1. passwd-al.hs</a></li>
<li><a href="#sec-1-7-2">1.7.2. buildmap.hs</a></li>
<li><a href="#sec-1-7-3">1.7.3. funcrecs.hs</a></li>
<li><a href="#sec-1-7-4">1.7.4. funcrecs2.hs</a></li>
<li><a href="#sec-1-7-5">1.7.5. passwdmap.hs</a></li>
</ul>
</li>
<li><a href="#sec-1-8">1.8. Chapter 14 - Monads</a>
<ul>
<li><a href="#sec-1-8-1">1.8.1. Maybe.hs</a></li>
<li><a href="#sec-1-8-2">1.8.2. MultiplyTo.hs</a></li>
<li><a href="#sec-1-8-3">1.8.3. SimpleState.hs</a></li>
<li><a href="#sec-1-8-4">1.8.4. State.hs</a></li>
</ul>
</li>
<li><a href="#sec-1-9">1.9. Chapter 27 - Sockets and Syslog</a>
<ul>
<li><a href="#sec-1-9-1">1.9.1. Requirements</a></li>
<li><a href="#sec-1-9-2">1.9.2. UDP Syslog Server and Client</a></li>
<li><a href="#sec-1-9-3">1.9.3. TCP Syslog Server and Client</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<lu> 
  <li><a href="/index.html">Index</a></li>
  <li><a href="https://github.com/caiorss/Functional-Programming">Repository</a></li>
</lu>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Real World Haskell Codes</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
<p>
It this section is provided Real World Haskell (RWH) files, testing
and running examples in Haskell v7.10.2. 
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Chapter 3  - Defining Types, Streamlining Functions</h3>
<div class="outline-text-3" id="text-1-2">
</div><div id="outline-container-sec-1-2-1" class="outline-4">
<h4 id="sec-1-2-1"><span class="section-number-4">1.2.1</span> BookStore.hs</h4>
<div class="outline-text-4" id="text-1-2-1">
<ul class="org-ul">
<li><a href="rwh/ch03/BookStore.hs">rwh/ch03/BookStore.hs</a>
</li>
</ul>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">BookInfo</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Book</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">String</span> [<span class="org-haskell-constructor">String</span>]
                <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Show</span>)



<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">MagazineInfo</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Magazine</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">String</span> [<span class="org-haskell-constructor">String</span>]
                    <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Show</span>)


<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">CustomerID</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Int</span>        <span class="org-comment-delimiter">--</span><span class="org-comment">- Type synonym </span>
<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">ReviewBody</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">String</span> 

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">BookReview</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">BookReview</span> <span class="org-haskell-constructor">BookInfo</span> <span class="org-haskell-constructor">CustomerID</span> <span class="org-haskell-constructor">String</span> 

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">BetterReviw</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">BetterReviw</span> <span class="org-haskell-constructor">BookInfo</span> <span class="org-haskell-constructor">CustomerID</span> <span class="org-haskell-constructor">ReviewBody</span> 

<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">BookRecord</span> <span class="org-haskell-operator">=</span> (<span class="org-haskell-constructor">BookInfo</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">BookReview</span>) 

<span class="org-haskell-definition">myInfo</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Book</span> 9780135072455 <span class="org-string">"Algebra of Programming"</span>
              [<span class="org-string">"Richard Bird"</span><span class="org-haskell-operator">,</span> <span class="org-string">"Oege de Moor"</span>]
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"rwh/ch03/BookStore.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( rwh<span class="org-haskell-operator">/</span>ch03<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">BookStore</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> myInfo
<span class="org-haskell-constructor">Book</span> 9780135072455 <span class="org-string">"Algebra of Programming"</span> [<span class="org-string">"Richard Bird"</span><span class="org-haskell-operator">,</span><span class="org-string">"Oege de Moor"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span><span class="org-haskell-keyword">type</span> myInfo
<span class="org-function-name">myInfo</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">BookInfo</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">Book</span> 0 <span class="org-string">"The Book of Imaginary Beings"</span> [<span class="org-string">"Jorge Luis Borges"</span>]
<span class="org-haskell-constructor">Book</span> 0 <span class="org-string">"The Book of Imaginary Beings"</span> [<span class="org-string">"Jorge Luis Borges"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span><span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">Book</span> 1 <span class="org-string">"Cosmicomics"</span> [<span class="org-string">"Italo Calvino"</span>]
<span class="org-haskell-constructor">Book</span> 1 <span class="org-string">"Cosmicomics"</span> [<span class="org-string">"Italo Calvino"</span>] <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">BookInfo</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-keyword">let</span> cities <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Book</span> 173 <span class="org-string">"Use of Weapons"</span> [<span class="org-string">"Iain M. Banks"</span>]

<span class="org-haskell-operator">&gt;&gt;&gt;</span> cities
<span class="org-haskell-constructor">Book</span> 173 <span class="org-string">"Use of Weapons"</span> [<span class="org-string">"Iain M. Banks"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-2-2" class="outline-4">
<h4 id="sec-1-2-2"><span class="section-number-4">1.2.2</span> BookStore2.hs</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
<a href="rwh/ch03/BookStore2.hs">rwh/ch03/BookStore2.hs</a> 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">CardHolder</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">String</span>
<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">CardNumber</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">String</span>
<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">Address</span> <span class="org-haskell-operator">=</span> [<span class="org-haskell-constructor">String</span>]
<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">CustomerID</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Int</span>

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">BillingInfo</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">CreditCard</span> <span class="org-haskell-constructor">CardNumber</span> <span class="org-haskell-constructor">CardHolder</span> <span class="org-haskell-constructor">Address</span>
                 <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">CashOnDelivery</span>
                 <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">Invoice</span> <span class="org-haskell-constructor">CustomerID</span>
                   <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Show</span>)
</pre>
</div>

<p>
Loading 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">CreditCard</span> <span class="org-string">"2901650221064486"</span> <span class="org-string">"Thomas Gradgrind"</span> [<span class="org-string">"Dickens"</span><span class="org-haskell-operator">,</span> <span class="org-string">"England"</span>]
<span class="org-haskell-constructor">CreditCard</span> <span class="org-string">"2901650221064486"</span> <span class="org-string">"Thomas Gradgrind"</span> [<span class="org-string">"Dickens"</span><span class="org-haskell-operator">,</span><span class="org-string">"England"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> it
<span class="org-haskell-constructor">CreditCard</span> <span class="org-string">"2901650221064486"</span> <span class="org-string">"Thomas Gradgrind"</span> [<span class="org-string">"Dickens"</span><span class="org-haskell-operator">,</span><span class="org-string">"England"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span><span class="org-haskell-keyword">type</span> it
<span class="org-function-name">it</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">BillingInfo</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-constructor">Invoice</span> 10
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">CashOnDelivery</span>
<span class="org-haskell-constructor">CashOnDelivery</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-2-3" class="outline-4">
<h4 id="sec-1-2-3"><span class="section-number-4">1.2.3</span> AlgebraicVector.hs</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
<a href="rwh/ch03/AlgebraicVector.hs">rwh/ch03/AlgebraicVector.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-comment-delimiter">-- </span><span class="org-comment">x and y coordinates or lengths.</span>
<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">Cartesian2D</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Cartesian2D</span> <span class="org-haskell-constructor">Double</span> <span class="org-haskell-constructor">Double</span> 
                   <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Eq</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Show</span>)

<span class="org-comment-delimiter">--</span><span class="org-comment">- Angle and distance (magnitude)</span>
<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">Polar2D</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Polar2D</span> <span class="org-haskell-constructor">Double</span> <span class="org-haskell-constructor">Double</span>  
               <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Eq</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Show</span>)
</pre>
</div>


<p>
Running 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">Cartesian2D</span> (sqrt 2) (sqrt 2)
<span class="org-haskell-constructor">Cartesian2D</span> 1.4142135623730951 1.4142135623730951
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">Polar2D</span> (pi <span class="org-haskell-operator">/</span> 4) 2
<span class="org-haskell-constructor">Polar2D</span> 0.7853981633974483 2.0
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-comment-delimiter">--</span><span class="org-comment">- The (==)  operator requires its arguments </span>
<span class="org-comment-delimiter">--</span><span class="org-comment">- to have the same type</span>
<span class="org-comment-delimiter">--</span><span class="org-comment">-</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">Cartesian2D</span> (sqrt 2) (sqrt 2) <span class="org-haskell-operator">==</span> <span class="org-haskell-constructor">Polar2D</span> (pi <span class="org-haskell-operator">/</span> 4) 2

<span class="org-haskell-operator">&lt;</span>interactive<span class="org-haskell-operator">&gt;:</span>58<span class="org-haskell-constructor">:</span>34<span class="org-haskell-constructor">:</span>
    <span class="org-haskell-constructor">Couldn't</span> match expected <span class="org-haskell-keyword">type</span> <span class="org-haskell-operator">&#8216;</span><span class="org-haskell-constructor">Cartesian2D</span><span class="org-haskell-operator">&#8217;</span>
                with actual <span class="org-haskell-keyword">type</span> <span class="org-haskell-operator">&#8216;</span><span class="org-haskell-constructor">Polar2D</span><span class="org-haskell-operator">&#8217;</span>
    <span class="org-haskell-constructor">In</span> the second argument <span class="org-haskell-keyword">of</span> <span class="org-haskell-operator">&#8216;</span>(<span class="org-haskell-operator">==</span>)<span class="org-haskell-operator">&#8217;,</span> namely <span class="org-haskell-operator">&#8216;</span><span class="org-haskell-constructor">Polar2D</span> (pi <span class="org-haskell-operator">/</span> 4) 2<span class="org-haskell-operator">&#8217;</span>
    <span class="org-haskell-constructor">In</span> the expression<span class="org-haskell-constructor">:</span>
      <span class="org-haskell-constructor">Cartesian2D</span> (sqrt 2) (sqrt 2) <span class="org-haskell-operator">==</span> <span class="org-haskell-constructor">Polar2D</span> (pi <span class="org-haskell-operator">/</span> 4) 2
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-2-4" class="outline-4">
<h4 id="sec-1-2-4"><span class="section-number-4">1.2.4</span> ShapeUnion.hs</h4>
<div class="outline-text-4" id="text-1-2-4">
<ul class="org-ul">
<li><a href="rwh/ShapeUnion.hs">rwh/ShapeUnion.hs</a> 
</li>
</ul>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">Vector</span> <span class="org-haskell-operator">=</span> (<span class="org-haskell-constructor">Double</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Double</span>)

<span class="org-haskell-keyword">data</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Shape</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Circle</span> <span class="org-haskell-constructor">Vector</span> <span class="org-haskell-constructor">Double</span> 
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">Poly</span> [<span class="org-haskell-constructor">Vector</span>]
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-2-5" class="outline-4">
<h4 id="sec-1-2-5"><span class="section-number-4">1.2.5</span> add.hs</h4>
<div class="outline-text-4" id="text-1-2-5">
<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-definition">sumList</span> (x<span class="org-haskell-constructor">:</span>xs) <span class="org-haskell-operator">=</span> x <span class="org-haskell-operator">+</span> sumList xs 
<span class="org-haskell-definition">sumList</span> <span class="org-haskell-constructor">[]</span>     <span class="org-haskell-operator">=</span> 0
</pre>
</div>

<p>
Loading 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"rwh/ch03/add.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( rwh<span class="org-haskell-operator">/</span>ch03<span class="org-haskell-operator">/</span>add<span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span>

<span class="org-haskell-operator">&gt;&gt;&gt;</span> sumList <span class="org-haskell-constructor">[]</span>
0
<span class="org-haskell-operator">&gt;&gt;&gt;</span> sumList [1<span class="org-haskell-operator">,</span> 2<span class="org-haskell-operator">,</span> 3<span class="org-haskell-operator">,</span> 4<span class="org-haskell-operator">,</span> 5<span class="org-haskell-operator">,</span> 6]
21
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-2-6" class="outline-4">
<h4 id="sec-1-2-6"><span class="section-number-4">1.2.6</span> BookStore3.hs</h4>
<div class="outline-text-4" id="text-1-2-6">
<ul class="org-ul">
<li><a href="rwh/ch03/BookStore3.hs">rwh/ch03/BookStore3.hs</a>
</li>
</ul>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">BookInfo</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Book</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">String</span> [<span class="org-haskell-constructor">String</span>]
                <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Show</span>)



<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">MagazineInfo</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Magazine</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">String</span> [<span class="org-haskell-constructor">String</span>]
                    <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Show</span>)


<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">CustomerID</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Int</span>        <span class="org-comment-delimiter">--</span><span class="org-comment">- Type synonym </span>
<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">ReviewBody</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">String</span> 

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">BookReview</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">BookReview</span> <span class="org-haskell-constructor">BookInfo</span> <span class="org-haskell-constructor">CustomerID</span> <span class="org-haskell-constructor">String</span> 

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">BetterReviw</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">BetterReviw</span> <span class="org-haskell-constructor">BookInfo</span> <span class="org-haskell-constructor">CustomerID</span> <span class="org-haskell-constructor">ReviewBody</span> 

<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">BookRecord</span> <span class="org-haskell-operator">=</span> (<span class="org-haskell-constructor">BookInfo</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">BookReview</span>) 

<span class="org-haskell-definition">bookID</span>      (<span class="org-haskell-constructor">Book</span> id title authors) <span class="org-haskell-operator">=</span> id
<span class="org-haskell-definition">bookTitle</span>   (<span class="org-haskell-constructor">Book</span> id title authors) <span class="org-haskell-operator">=</span> title
<span class="org-haskell-definition">bookAuthors</span> (<span class="org-haskell-constructor">Book</span> id title authors) <span class="org-haskell-operator">=</span> authors

<span class="org-haskell-definition">myInfo</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Book</span> 9780135072455 <span class="org-string">"Algebra of Programming"</span>
              [<span class="org-string">"Richard Bird"</span><span class="org-haskell-operator">,</span> <span class="org-string">"Oege de Moor"</span>]
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"rwh/ch03/BookStore3.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( rwh<span class="org-haskell-operator">/</span>ch03<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">BookStore3</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> bookID (<span class="org-haskell-constructor">Book</span> 3 <span class="org-string">"Probability Theory"</span> [<span class="org-string">"E.T.H. Jaynes"</span>])
3
<span class="org-haskell-operator">&gt;&gt;&gt;</span> bookTitle (<span class="org-haskell-constructor">Book</span> 3 <span class="org-string">"Probability Theory"</span> [<span class="org-string">"E.T.H. Jaynes"</span>])
<span class="org-string">"Probability Theory"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> bookAuthors (<span class="org-haskell-constructor">Book</span> 3 <span class="org-string">"Probability Theory"</span> [<span class="org-string">"E.T.H. Jaynes"</span>])
[<span class="org-string">"E.T.H. Jaynes"</span>]

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span><span class="org-haskell-keyword">type</span> bookID
<span class="org-function-name">bookID</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">BookInfo</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span><span class="org-haskell-keyword">type</span> bookTitle
<span class="org-function-name">bookTitle</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">BookInfo</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span><span class="org-haskell-keyword">type</span> bookAuthors
<span class="org-function-name">bookAuthors</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">BookInfo</span> <span class="org-haskell-operator">-&gt;</span> [<span class="org-haskell-constructor">String</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-2-7" class="outline-4">
<h4 id="sec-1-2-7"><span class="section-number-4">1.2.7</span> BookStore4.hs</h4>
<div class="outline-text-4" id="text-1-2-7">
<ul class="org-ul">
<li><a href="rwh/ch03/BookStore4.hs">rwh/ch03/BookStore4.hs</a> 
</li>
</ul>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">BookInfo</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Book</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">String</span> [<span class="org-haskell-constructor">String</span>]
                <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Show</span>)



<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">MagazineInfo</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Magazine</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">String</span> [<span class="org-haskell-constructor">String</span>]
                    <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Show</span>)


<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">CustomerID</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Int</span>        <span class="org-comment-delimiter">--</span><span class="org-comment">- Type synonym </span>
<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">ReviewBody</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">String</span> 
<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">Address</span> <span class="org-haskell-operator">=</span> [<span class="org-haskell-constructor">String</span>] 

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">BookReview</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">BookReview</span> <span class="org-haskell-constructor">BookInfo</span> <span class="org-haskell-constructor">CustomerID</span> <span class="org-haskell-constructor">String</span> 

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">BetterReviw</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">BetterReviw</span> <span class="org-haskell-constructor">BookInfo</span> <span class="org-haskell-constructor">CustomerID</span> <span class="org-haskell-constructor">ReviewBody</span> 

<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">BookRecord</span> <span class="org-haskell-operator">=</span> (<span class="org-haskell-constructor">BookInfo</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">BookReview</span>) 

<span class="org-haskell-definition">bookID</span>      (<span class="org-haskell-constructor">Book</span> id title authors) <span class="org-haskell-operator">=</span> id
<span class="org-haskell-definition">bookTitle</span>   (<span class="org-haskell-constructor">Book</span> id title authors) <span class="org-haskell-operator">=</span> title
<span class="org-haskell-definition">bookAuthors</span> (<span class="org-haskell-constructor">Book</span> id title authors) <span class="org-haskell-operator">=</span> authors


<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">Customer</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Customer</span> {
      customerID      <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">CustomerID</span>
    <span class="org-haskell-operator">,</span> customerName    <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span>
    <span class="org-haskell-operator">,</span> customerAddress <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Address</span>
    } <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Show</span>)

<span class="org-haskell-definition">myInfo</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Book</span> 9780135072455 <span class="org-string">"Algebra of Programming"</span>
              [<span class="org-string">"Richard Bird"</span><span class="org-haskell-operator">,</span> <span class="org-string">"Oege de Moor"</span>]

<span class="org-haskell-definition">customer1</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Customer</span> 271828 <span class="org-string">"J.R. Hacker"</span>
            [<span class="org-string">"255 Syntax Ct"</span><span class="org-haskell-operator">,</span>
             <span class="org-string">"Milpitas, CA 95134"</span><span class="org-haskell-operator">,</span>
             <span class="org-string">"USA"</span>]

<span class="org-haskell-definition">customer2</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Customer</span> {
              customerID <span class="org-haskell-operator">=</span> 271828
            <span class="org-haskell-operator">,</span> customerAddress <span class="org-haskell-operator">=</span> [<span class="org-string">"1048576 Disk Drive"</span><span class="org-haskell-operator">,</span>
                                 <span class="org-string">"Milpitas, CA 95134"</span><span class="org-haskell-operator">,</span>
                                 <span class="org-string">"USA"</span>]
            <span class="org-haskell-operator">,</span> customerName <span class="org-haskell-operator">=</span> <span class="org-string">"Jane Q. Citizen"</span>
            }
</pre>
</div>


<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"rwh/ch03/BookStore4.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( rwh<span class="org-haskell-operator">/</span>ch03<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">BookStore4</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> customer1
<span class="org-haskell-constructor">Customer</span> {customerID <span class="org-haskell-operator">=</span> 271828<span class="org-haskell-operator">,</span> customerName <span class="org-haskell-operator">=</span> <span class="org-string">"J.R. Hacker"</span><span class="org-haskell-operator">,</span> customerAddress <span class="org-haskell-operator">=</span> [<span class="org-string">"255 Syntax Ct"</span><span class="org-haskell-operator">,</span><span class="org-string">"Milpitas, CA 95134"</span><span class="org-haskell-operator">,</span><span class="org-string">"USA"</span>]}
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> customer2
<span class="org-haskell-constructor">Customer</span> {customerID <span class="org-haskell-operator">=</span> 271828<span class="org-haskell-operator">,</span> customerName <span class="org-haskell-operator">=</span> <span class="org-string">"Jane Q. Citizen"</span><span class="org-haskell-operator">,</span> customerAddress <span class="org-haskell-operator">=</span> [<span class="org-string">"1048576 Disk Drive"</span><span class="org-haskell-operator">,</span><span class="org-string">"Milpitas, CA 95134"</span><span class="org-haskell-operator">,</span><span class="org-string">"USA"</span>]}
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> customerID customer1
271828
<span class="org-haskell-operator">&gt;&gt;&gt;</span> customerID customer2
271828
<span class="org-haskell-operator">&gt;&gt;&gt;</span> customerName customer1
<span class="org-string">"J.R. Hacker"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> customerAddress customer1
[<span class="org-string">"255 Syntax Ct"</span><span class="org-haskell-operator">,</span><span class="org-string">"Milpitas, CA 95134"</span><span class="org-haskell-operator">,</span><span class="org-string">"USA"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t customerName
<span class="org-function-name">customerName</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Customer</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span>  <span class="org-haskell-constructor">:</span>t customerAddress
<span class="org-function-name">customerAddress</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Customer</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Address</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t customerID
<span class="org-function-name">customerID</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Customer</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">CustomerID</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Chapter 4  - Functional Programming</h3>
<div class="outline-text-3" id="text-1-3">
</div><div id="outline-container-sec-1-3-1" class="outline-4">
<h4 id="sec-1-3-1"><span class="section-number-4">1.3.1</span> InteractWith.hs</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
Page 71: <a href="rwh/ch04/InteractWith.hs">rwh/ch04/InteractWith.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">System.Environment</span> (getArgs)

<span class="org-haskell-definition">interactWith</span> function inputFile outputFile <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
  input <span class="org-haskell-operator">&lt;-</span> readFile inputFile
  writeFile outputFile (function input)

<span class="org-haskell-definition">main</span> <span class="org-haskell-operator">=</span> mainWith myFunction
  <span class="org-haskell-keyword">where</span> mainWith function <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
          args <span class="org-haskell-operator">&lt;-</span> getArgs
          <span class="org-haskell-keyword">case</span> args <span class="org-haskell-keyword">of</span>
            [input<span class="org-haskell-operator">,</span>output] <span class="org-haskell-operator">-&gt;</span> interactWith function input output
            <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> putStrLn <span class="org-string">"error: exactly two arguments needed"</span>

        <span class="org-comment-delimiter">-- </span><span class="org-comment">replace "id" with the name of our function below</span>
        myFunction <span class="org-haskell-operator">=</span> id
</pre>
</div>

<p>
Running:
</p>

<pre class="example">
$ ghc --make InteractWith 
[1 of 1] Compiling Main             ( InteractWith.hs, InteractWith.o )
Linking InteractWith ...

$ ./InteractWith /etc/issue 
error: exactly two arguments needed

$ ./InteractWith /etc/issue /tmp/issue.out

$ cat /tmp/issue.out 
Arch Linux \r (\l)
</pre>
</div>
</div>
<div id="outline-container-sec-1-3-2" class="outline-4">
<h4 id="sec-1-3-2"><span class="section-number-4">1.3.2</span> FixLines.hs</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
Page 73: <a href="rwh/ch04/FixLines.hs">rwh/ch04/FixLines.hs</a> 
</p>


<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">System.Environment</span> (getArgs)

<span class="org-haskell-definition">interactWith</span> function inputFile outputFile <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
  input <span class="org-haskell-operator">&lt;-</span> readFile inputFile
  writeFile outputFile (function input)

<span class="org-haskell-definition">splitLines</span> <span class="org-haskell-constructor">[]</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">[]</span>
<span class="org-haskell-definition">splitLines</span> cs <span class="org-haskell-operator">=</span>
    <span class="org-haskell-keyword">let</span> (pre<span class="org-haskell-operator">,</span> suf) <span class="org-haskell-operator">=</span> break isLineTerminator cs
    <span class="org-haskell-keyword">in</span>  pre <span class="org-haskell-constructor">:</span> <span class="org-haskell-keyword">case</span> suf <span class="org-haskell-keyword">of</span> 
                (<span class="org-string">'\r'</span><span class="org-haskell-constructor">:</span><span class="org-string">'\n'</span><span class="org-haskell-constructor">:</span>rest) <span class="org-haskell-operator">-&gt;</span> splitLines rest
                (<span class="org-string">'\r'</span><span class="org-haskell-constructor">:</span>rest)      <span class="org-haskell-operator">-&gt;</span> splitLines rest
                (<span class="org-string">'\n'</span><span class="org-haskell-constructor">:</span>rest)      <span class="org-haskell-operator">-&gt;</span> splitLines rest
                <span class="org-haskell-keyword">_</span>                <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">[]</span>

<span class="org-haskell-definition">isLineTerminator</span> c <span class="org-haskell-operator">=</span> c <span class="org-haskell-operator">==</span> <span class="org-string">'\r'</span> <span class="org-haskell-operator">||</span> c <span class="org-haskell-operator">==</span> <span class="org-string">'\n'</span>

<span class="org-function-name">fixLines</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span>
<span class="org-haskell-definition">fixLines</span> input <span class="org-haskell-operator">=</span> unlines (splitLines input)


<span class="org-haskell-definition">main</span> <span class="org-haskell-operator">=</span> mainWith myFunction
  <span class="org-haskell-keyword">where</span> mainWith function <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
          args <span class="org-haskell-operator">&lt;-</span> getArgs
          <span class="org-haskell-keyword">case</span> args <span class="org-haskell-keyword">of</span>
            [input<span class="org-haskell-operator">,</span>output] <span class="org-haskell-operator">-&gt;</span> interactWith function input output
            <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> putStrLn <span class="org-string">"error: exactly two arguments needed"</span>

        <span class="org-comment-delimiter">-- </span><span class="org-comment">replace "id" with the name of our function below</span>
        myFunction <span class="org-haskell-operator">=</span> fixLines
</pre>
</div>


<p>
Running Interactive:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"rwh/ch04/FixLines.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( rwh<span class="org-haskell-operator">/</span>ch04<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">FixLines</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> break odd [2<span class="org-haskell-operator">,</span> 4<span class="org-haskell-operator">,</span> 5<span class="org-haskell-operator">,</span> 6<span class="org-haskell-operator">,</span> 8]
([2<span class="org-haskell-operator">,</span>4]<span class="org-haskell-operator">,</span>[5<span class="org-haskell-operator">,</span>6<span class="org-haskell-operator">,</span>8])

<span class="org-haskell-operator">&gt;&gt;&gt;</span> splitLines <span class="org-string">"line1\nline2\r\nline3\r\n"</span>
[<span class="org-string">"line1"</span><span class="org-haskell-operator">,</span><span class="org-string">"line2"</span><span class="org-haskell-operator">,</span><span class="org-string">"line3"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>


<p>
Running in batch mode:
</p>

<div class="org-src-container">

<pre class="src src-sh">$ curl -O http://www.gnu.org/licenses/gpl-3.0.txt

$ file gpl-3.0.txt 
<span class="org-function-name">gpl-3.0.txt</span>: ASCII text

<span class="org-comment-delimiter">#  </span><span class="org-comment">dos2unix replacement </span>
<span class="org-comment-delimiter">#</span>
$ awk <span class="org-string">'sub("$", "\r")'</span> gpl-3.0.txt  &gt;  gpl-3.0.dos.txt

$ file gpl-3.0.dos.txt 
<span class="org-function-name">gpl-3.0.dos.txt</span>: ASCII text, with CRLF line terminators

$ ghc --make FixLines
[1 of 1] Compiling Main             ( FixLines.hs, FixLines.o )
Linking FixLines ...

$ file FixLines
<span class="org-function-name">FixLines</span>: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically 
linked, interpreter 
/nix/store/n2wxp513rr00f6hr2dy0waqahns49dch-glibc-2.21/lib/ld-linux-x86-64.so.2, 
<span class="org-keyword">for</span> GNU/Linux 2.6.32, not stripped


$ ./FixLines 
<span class="org-function-name">error</span>: exactly two arguments needed

$ ./FixLines gpl-3.0.dos.txt gpl-3.0.unix.txt

$ file gpl-3.0.unix.txt 
<span class="org-function-name">gpl-3.0.unix.txt</span>: ASCII text
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-3-3" class="outline-4">
<h4 id="sec-1-3-3"><span class="section-number-4">1.3.3</span> ch4.exercises.hs</h4>
<div class="outline-text-4" id="text-1-3-3">
<ol class="org-ol">
<li>Write your own “safe” definitions of the standard partial list
</li>
</ol>
<p>
functions, but make sure they never fail. As a hint, you might want to
consider using the following types:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-function-name">safeHead</span> <span class="org-haskell-operator">::</span> [a] <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> a
<span class="org-function-name">safeTail</span> <span class="org-haskell-operator">::</span> [a] <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> [a]
<span class="org-function-name">safeLast</span> <span class="org-haskell-operator">::</span> [a] <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> a
<span class="org-function-name">safeInit</span> <span class="org-haskell-operator">::</span> [a] <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> [a]
</pre>
</div>


<ol class="org-ol">
<li>Write a function splitWith  that acts similarly to words  but takes a predicate and a
</li>
</ol>
<p>
list of any type, and then splits its input list on every element for which the predicate
returns False:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-comment-delimiter">-- </span><span class="org-comment">file: ch04/ch04.exercises.hs</span>
<span class="org-function-name">splitWith</span> <span class="org-haskell-operator">::</span> (a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Bool</span>) <span class="org-haskell-operator">-&gt;</span> [a] <span class="org-haskell-operator">-&gt;</span> [[a]]
</pre>
</div>


<p>
Page 84: <a href="rwh/ch04/ch04.exercises.hs">rwh/ch04/ch04.exercises.hs</a> 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-function-name">safeHead</span> <span class="org-haskell-operator">::</span> [a] <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> a
<span class="org-haskell-definition">safeHead</span> (head<span class="org-haskell-constructor">:</span>rest) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> head
<span class="org-haskell-definition">safeHead</span> <span class="org-haskell-constructor">[]</span>   <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span>

<span class="org-function-name">safeTail</span> <span class="org-haskell-operator">::</span> [a] <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> [a]
<span class="org-haskell-definition">safeTail</span> (head<span class="org-haskell-constructor">:</span>rest) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> rest 
<span class="org-haskell-definition">safeTail</span> <span class="org-haskell-constructor">[]</span>          <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span> 


<span class="org-function-name">safeLast</span> <span class="org-haskell-operator">::</span> [a] <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> a
<span class="org-haskell-definition">safeLast</span> [x] <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> x
<span class="org-haskell-definition">safeLast</span> (hd<span class="org-haskell-constructor">:</span>tl) <span class="org-haskell-operator">=</span> safeLast tl 
<span class="org-haskell-definition">safeLast</span> <span class="org-haskell-constructor">[]</span>  <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span>

<span class="org-function-name">safeInit</span> <span class="org-haskell-operator">::</span> [a] <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> [a]
<span class="org-haskell-definition">safeInit</span> (x<span class="org-haskell-constructor">:</span>xs)      <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> <span class="org-haskell-operator">$</span> init (x<span class="org-haskell-constructor">:</span>xs)
<span class="org-haskell-definition">safeInit</span> <span class="org-haskell-constructor">[]</span>          <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span> 

<span class="org-comment-delimiter">{-</span>
<span class="org-comment">splitWith_aux :: (a -&gt; Bool) -&gt; [a] -&gt; [[a]] -&gt; [[a]]</span>
<span class="org-comment">splitWith_aux fnp []     acc  = [] </span>
<span class="org-comment">splitWith_aux fnp (x:xs) acc  = if fnp x</span>
<span class="org-comment">                                then  splitWith_aux fnp xs  </span>

<span class="org-comment">-}</span>
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"rwh/ch04/ch04.exercises.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( rwh<span class="org-haskell-operator">/</span>ch04<span class="org-haskell-operator">/</span>ch04<span class="org-haskell-operator">.</span>exercises<span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> safeHead [1<span class="org-haskell-operator">,</span> 2<span class="org-haskell-operator">,</span> 3<span class="org-haskell-operator">,</span> 4]
<span class="org-haskell-constructor">Just</span> 1
<span class="org-haskell-operator">&gt;&gt;&gt;</span> safeHead [1 <span class="org-haskell-operator">..</span>]
<span class="org-haskell-constructor">Just</span> 1
<span class="org-haskell-operator">&gt;&gt;&gt;</span> safeHead <span class="org-haskell-constructor">[]</span>
<span class="org-haskell-constructor">Nothing</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> safeTail [1<span class="org-haskell-operator">,</span> 2<span class="org-haskell-operator">,</span> 3<span class="org-haskell-operator">,</span> 4]
<span class="org-haskell-constructor">Just</span> [2<span class="org-haskell-operator">,</span>3<span class="org-haskell-operator">,</span>4]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> safeTail <span class="org-haskell-constructor">[]</span>
<span class="org-haskell-constructor">Nothing</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> safeLast [1<span class="org-haskell-operator">,</span> 2<span class="org-haskell-operator">,</span> 3<span class="org-haskell-operator">,</span> 4]
<span class="org-haskell-constructor">Just</span> 4
<span class="org-haskell-operator">&gt;&gt;&gt;</span> safeLast [4]
<span class="org-haskell-constructor">Just</span> 4
<span class="org-haskell-operator">&gt;&gt;&gt;</span> safeLast <span class="org-haskell-constructor">[]</span>
<span class="org-haskell-constructor">Nothing</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> safeInit <span class="org-haskell-constructor">[]</span>
<span class="org-haskell-constructor">Nothing</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> safeInit [1<span class="org-haskell-operator">,</span> 2<span class="org-haskell-operator">,</span> 3<span class="org-haskell-operator">,</span> 4<span class="org-haskell-operator">,</span> 5]
<span class="org-haskell-constructor">Just</span> [1<span class="org-haskell-operator">,</span>2<span class="org-haskell-operator">,</span>3<span class="org-haskell-operator">,</span>4]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> safeInit [1]
<span class="org-haskell-constructor">Just</span> <span class="org-haskell-constructor">[]</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-3-4" class="outline-4">
<h4 id="sec-1-3-4"><span class="section-number-4">1.3.4</span> IntParser.hs</h4>
<div class="outline-text-4" id="text-1-3-4">
<p>
Page 86: <a href="rwh/ch04/IntParse.hs">rwh/ch04/IntParse.hs</a> 
</p>


<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.Char</span> (digitToInt)

<span class="org-function-name">asInt</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int</span> 
<span class="org-haskell-definition">asInt</span> xs <span class="org-haskell-operator">=</span> loop 0 xs

<span class="org-function-name">loop</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int</span> 
<span class="org-haskell-definition">loop</span> acc <span class="org-haskell-constructor">[]</span> <span class="org-haskell-operator">=</span> acc
<span class="org-haskell-definition">loop</span> acc (x<span class="org-haskell-constructor">:</span>xs) <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">let</span> acc' <span class="org-haskell-operator">=</span> acc <span class="org-haskell-operator">*</span> 10 <span class="org-haskell-operator">+</span> digitToInt x
                  <span class="org-haskell-keyword">in</span> loop acc' xs
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;:</span>load rwh<span class="org-haskell-operator">/</span>ch04<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">IntParse</span><span class="org-haskell-operator">.</span>hs 
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( rwh<span class="org-haskell-operator">/</span>ch04<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">IntParse</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> digitToInt <span class="org-string">'9'</span>
9
<span class="org-haskell-operator">&gt;&gt;&gt;</span> digitToInt <span class="org-string">'a'</span>
10
<span class="org-haskell-operator">&gt;&gt;&gt;</span> digitToInt <span class="org-string">'x'</span>
 <span class="org-haskell-operator">***</span> <span class="org-haskell-constructor">Exception:</span> <span class="org-haskell-constructor">Char</span><span class="org-haskell-operator">.</span>digitToInt<span class="org-haskell-constructor">:</span> not a digit <span class="org-string">'x'</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> asInt <span class="org-string">"33"</span>
33
<span class="org-haskell-operator">&gt;&gt;&gt;</span> asInt <span class="org-string">"100"</span>
100
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t asInt
<span class="org-function-name">asInt</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> asInt <span class="org-string">"not a number"</span>
 <span class="org-haskell-operator">***</span> <span class="org-haskell-constructor">Exception:</span> <span class="org-haskell-constructor">Char</span><span class="org-haskell-operator">.</span>digitToInt<span class="org-haskell-constructor">:</span> not a digit <span class="org-string">'n'</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Chapter 5  - Writing a Library: Working with JSON Data</h3>
<div class="outline-text-3" id="text-1-4">
</div><div id="outline-container-sec-1-4-1" class="outline-4">
<h4 id="sec-1-4-1"><span class="section-number-4">1.4.1</span> SimpleJson1.hs</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
Page: 112 <a href="rwh/ch05/SimpleJSON1.hs">rwh/ch05/SimpleJSON1.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">JString</span> <span class="org-haskell-constructor">String</span>
            <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">JNumber</span> <span class="org-haskell-constructor">Double</span> 
            <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">Bool</span>
            <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">JNull</span> 
            <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">JObject</span> [(<span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">JValue</span>)]
            <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">JArray</span>  [<span class="org-haskell-constructor">JValue</span>]
            <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Eq</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Ord</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Show</span>)

<span class="org-function-name">getString</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">String</span> 
<span class="org-haskell-definition">getString</span> (<span class="org-haskell-constructor">JString</span> s) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> s
<span class="org-haskell-definition">getString</span> <span class="org-haskell-keyword">_</span>           <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span>

<span class="org-function-name">getBool</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Bool</span> 
<span class="org-haskell-definition">getBool</span> (<span class="org-haskell-constructor">JBool</span> b) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> b 
<span class="org-haskell-definition">getBool</span> <span class="org-haskell-keyword">_</span>         <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span> 

<span class="org-function-name">getNumber</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Double</span>
<span class="org-haskell-definition">getNumber</span> (<span class="org-haskell-constructor">JNumber</span> n) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> n
<span class="org-haskell-definition">getNumber</span> <span class="org-haskell-keyword">_</span>           <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span>

<span class="org-function-name">getObject</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> [(<span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">JValue</span>)]
<span class="org-haskell-definition">getObject</span> js <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">case</span> js <span class="org-haskell-keyword">of</span>
               <span class="org-haskell-constructor">JObject</span> xs <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Just</span> xs
               <span class="org-haskell-keyword">_</span>          <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span> 


<span class="org-function-name">getArray</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> [<span class="org-haskell-constructor">JValue</span>]
<span class="org-haskell-definition">getArray</span> js <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">case</span> js <span class="org-haskell-keyword">of</span>
              <span class="org-haskell-constructor">JArray</span> xs <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Just</span> xs
              <span class="org-haskell-keyword">_</span>         <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span> 

<span class="org-function-name">isNull</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Bool</span> 
<span class="org-haskell-definition">isNull</span> <span class="org-haskell-constructor">JNull</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">True</span>
<span class="org-haskell-definition">isNull</span> <span class="org-haskell-keyword">_</span>     <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">False</span>
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"rwh/ch05/SimpleJSON1.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( rwh<span class="org-haskell-operator">/</span>ch05<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">SimpleJSON1</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">JString</span> <span class="org-string">"New Jersey"</span>
<span class="org-haskell-constructor">JString</span> <span class="org-string">"New Jersey"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">JNumber</span> 3.1415
<span class="org-haskell-constructor">JNumber</span> 3.1415
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">False</span>
<span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">False</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">True</span>
<span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">True</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> getString (<span class="org-haskell-constructor">JNumber</span> 3)
<span class="org-haskell-constructor">Nothing</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> getString (<span class="org-haskell-constructor">JString</span> <span class="org-string">"Utah"</span> )
<span class="org-haskell-constructor">Just</span> <span class="org-string">"Utah"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> getNumber (<span class="org-haskell-constructor">JNumber</span> 10.2323)
<span class="org-haskell-constructor">Just</span> 10.2323
<span class="org-haskell-operator">&gt;&gt;&gt;</span> getNumber (<span class="org-haskell-constructor">JString</span> <span class="org-string">"Texas"</span>)
<span class="org-haskell-constructor">Nothing</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> getBool (<span class="org-haskell-constructor">JString</span> <span class="org-string">"Alabama"</span>)
<span class="org-haskell-constructor">Nothing</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> getBool (<span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">False</span>)
<span class="org-haskell-constructor">Just</span> <span class="org-haskell-constructor">False</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> getArray (<span class="org-haskell-constructor">JArray</span> [<span class="org-haskell-constructor">JString</span> <span class="org-string">"Alabama"</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">JNumber</span> 102.23<span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">True</span>])
<span class="org-haskell-constructor">Just</span> [<span class="org-haskell-constructor">JString</span> <span class="org-string">"Alabama"</span><span class="org-haskell-operator">,</span><span class="org-haskell-constructor">JNumber</span> 102.23<span class="org-haskell-operator">,</span><span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">True</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> getObject (<span class="org-haskell-constructor">JObject</span> [(<span class="org-string">"Alabama"</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">JNumber</span> 0)<span class="org-haskell-operator">,</span> (<span class="org-string">"Texas"</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">JNumber</span> 2)<span class="org-haskell-operator">,</span> (<span class="org-string">"Nevada"</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">JNumber</span> 20)<span class="org-haskell-operator">,</span> (<span class="org-string">"New York"</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">JNumber</span> 40)])
<span class="org-haskell-constructor">Just</span> [(<span class="org-string">"Alabama"</span><span class="org-haskell-operator">,</span><span class="org-haskell-constructor">JNumber</span> 0.0)<span class="org-haskell-operator">,</span>(<span class="org-string">"Texas"</span><span class="org-haskell-operator">,</span><span class="org-haskell-constructor">JNumber</span> 2.0)<span class="org-haskell-operator">,</span>(<span class="org-string">"Nevada"</span><span class="org-haskell-operator">,</span><span class="org-haskell-constructor">JNumber</span> 20.0)<span class="org-haskell-operator">,</span>(<span class="org-string">"New York"</span><span class="org-haskell-operator">,</span><span class="org-haskell-constructor">JNumber</span> 40.0)]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> isNull <span class="org-haskell-constructor">JNull</span>
<span class="org-haskell-constructor">True</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> isNull (<span class="org-haskell-constructor">JString</span> <span class="org-string">"California"</span>)
<span class="org-haskell-constructor">False</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-4-2" class="outline-4">
<h4 id="sec-1-4-2"><span class="section-number-4">1.4.2</span> SimpleJSon2.hs</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
Page: 112 - File: <a href="rwh/ch05/SimpleJSON2.hs">rwh/ch05/SimpleJSON2.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">module</span> <span class="org-haskell-constructor">SimpleJSON2</span>
       (
         <span class="org-haskell-constructor">JValue</span> (<span class="org-haskell-operator">..</span>)
         <span class="org-haskell-operator">,</span> getString
         <span class="org-haskell-operator">,</span> getInt
         <span class="org-haskell-operator">,</span> getDouble
         <span class="org-haskell-operator">,</span> getObject
         <span class="org-haskell-operator">,</span> getArray
         <span class="org-haskell-operator">,</span> isNull
       ) <span class="org-haskell-keyword">where</span> 

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">JString</span> <span class="org-haskell-constructor">String</span>
            <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">JNumber</span> <span class="org-haskell-constructor">Double</span> 
            <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">Bool</span>
            <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">JNull</span> 
            <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">JObject</span> [(<span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">JValue</span>)]
            <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">JArray</span>  [<span class="org-haskell-constructor">JValue</span>]
            <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Eq</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Ord</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Show</span>)

<span class="org-function-name">getString</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">String</span> 
<span class="org-haskell-definition">getString</span> (<span class="org-haskell-constructor">JString</span> s) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> s
<span class="org-haskell-definition">getString</span> <span class="org-haskell-keyword">_</span>           <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span>

<span class="org-function-name">getBool</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Bool</span> 
<span class="org-haskell-definition">getBool</span> (<span class="org-haskell-constructor">JBool</span> b) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> b 
<span class="org-haskell-definition">getBool</span> <span class="org-haskell-keyword">_</span>         <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span> 

<span class="org-function-name">getNumber</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Double</span>
<span class="org-haskell-definition">getNumber</span> (<span class="org-haskell-constructor">JNumber</span> n) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> n
<span class="org-haskell-definition">getNumber</span> <span class="org-haskell-keyword">_</span>           <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span>

<span class="org-haskell-definition">getDouble</span> <span class="org-haskell-operator">=</span> getNumber 

<span class="org-function-name">getObject</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> [(<span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">JValue</span>)]
<span class="org-haskell-definition">getObject</span> js <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">case</span> js <span class="org-haskell-keyword">of</span>
               <span class="org-haskell-constructor">JObject</span> xs <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Just</span> xs
               <span class="org-haskell-keyword">_</span>          <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span> 


<span class="org-function-name">getArray</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> [<span class="org-haskell-constructor">JValue</span>]
<span class="org-haskell-definition">getArray</span> js <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">case</span> js <span class="org-haskell-keyword">of</span>
              <span class="org-haskell-constructor">JArray</span> xs <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Just</span> xs
              <span class="org-haskell-keyword">_</span>         <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span> 

<span class="org-haskell-definition">getInt</span> (<span class="org-haskell-constructor">JNumber</span> n) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> (truncate n)
<span class="org-haskell-definition">getInt</span> <span class="org-haskell-keyword">_</span>           <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span> 

<span class="org-function-name">isNull</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Bool</span> 
<span class="org-haskell-definition">isNull</span> <span class="org-haskell-constructor">JNull</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">True</span>
</pre>
</div>


<p>
File: <a href="rwh/ch05/Main.hs">rwh/ch05/Main.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">module</span> <span class="org-haskell-constructor">Main</span> (main) <span class="org-haskell-keyword">where</span>

<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">SimpleJSON2</span>

<span class="org-haskell-definition">main</span> <span class="org-haskell-operator">=</span> print (<span class="org-haskell-constructor">JObject</span> [(<span class="org-string">"foo"</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">JNumber</span> 1)<span class="org-haskell-operator">,</span> (<span class="org-string">"bar"</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">False</span>)])
</pre>
</div>

<p>
Compile the module:
</p>

<div class="org-src-container">

<pre class="src src-sh">$ alias <span class="org-variable-name">ghc</span>=/nix/store/fcwp5nswfq4wm4hc3c9ij8rap9dr9p3q-ghc-7.10.2/bin/ghc

<span class="org-comment-delimiter"># </span><span class="org-comment">Generate only object code</span>
<span class="org-comment-delimiter">#</span>
$ ghc -c SimpleJSON2.hs


$ file SimpleJSON2.o 
<span class="org-function-name">SimpleJSON2.o</span>: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped

$ file SimpleJSON2.hi
<span class="org-function-name">SimpleJSON2.hi</span>: data


<span class="org-comment-delimiter"># </span><span class="org-comment">Error:</span>
<span class="org-comment-delimiter">#</span>
$ ghc -o <span class="org-keyword">simple</span> Main.hs SimpleJSON2.o
Linking simple ...
<span class="org-function-name">SimpleJSON2.o</span>:(.data+0x0): multiple definition of <span class="org-sh-quoted-exec">`__stginit_SimpleJSON2'</span>
<span class="org-sh-quoted-exec">./SimpleJSON2.o:(.data+0x0): first defined here</span>
<span class="org-sh-quoted-exec">SimpleJSON2.o:(.data+0x0): multiple definition of `</span>SimpleJSON2_isNull_closure<span class="org-string">'</span>
<span class="org-string">./SimpleJSON2.o:(.data+0x0): first defined here</span>
<span class="org-string">...</span>
<span class="org-string">SimpleJSON2.o: In function `SimpleJSON2_JArray_info'</span>:
(.text+0x24f0): multiple definition of <span class="org-sh-quoted-exec">`SimpleJSON2_JArray_static_info'</span>
<span class="org-sh-quoted-exec">./SimpleJSON2.o:(.text+0x24f0): first defined here</span>
<span class="org-sh-quoted-exec">collect2: error: ld returned 1 exit status</span>


<span class="org-sh-quoted-exec"># Now it works </span>
<span class="org-sh-quoted-exec">#</span>
<span class="org-sh-quoted-exec">$ ghc --make -o simple Main.hs</span>
<span class="org-sh-quoted-exec">Linking simple ...</span>

<span class="org-sh-quoted-exec">$ file simple </span>
<span class="org-sh-quoted-exec">simple: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, </span>
<span class="org-sh-quoted-exec">interpreter /nix/store/n2wxp513rr00f6hr2dy0waqahns49dch-glibc-2.21/lib/ld-linux-x86-64.so.2, </span>
<span class="org-sh-quoted-exec">for GNU/Linux 2.6.32, not stripped</span>

<span class="org-sh-quoted-exec">$ ./simple </span>
<span class="org-sh-quoted-exec">JObject [("foo",JNumber 1.0),("bar",JBool False)]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-4-3" class="outline-4">
<h4 id="sec-1-4-3"><span class="section-number-4">1.4.3</span> PutJSON.hs</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
Page: 116 <a href="rwh/ch05/PutJson.hs">rwh/ch05/PutJson.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">module</span> <span class="org-haskell-constructor">PutJSON</span> <span class="org-haskell-keyword">where</span>

<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.List</span> (intercalate)
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">SimpleJSON2</span>

<span class="org-function-name">renderJValue</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span>
<span class="org-haskell-definition">renderJValue</span> (<span class="org-haskell-constructor">JString</span> s)   <span class="org-haskell-operator">=</span> show s
<span class="org-haskell-definition">renderJValue</span> (<span class="org-haskell-constructor">JNumber</span> n)   <span class="org-haskell-operator">=</span> show n
<span class="org-haskell-definition">renderJValue</span> (<span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">True</span>)  <span class="org-haskell-operator">=</span> <span class="org-string">"true"</span>
<span class="org-haskell-definition">renderJValue</span> (<span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">False</span>) <span class="org-haskell-operator">=</span> <span class="org-string">"false"</span>
<span class="org-haskell-definition">renderJValue</span> <span class="org-haskell-constructor">JNull</span>         <span class="org-haskell-operator">=</span> <span class="org-string">"null"</span>

<span class="org-haskell-definition">renderJValue</span> (<span class="org-haskell-constructor">JObject</span> o) <span class="org-haskell-operator">=</span> <span class="org-string">"{"</span> <span class="org-haskell-operator">++</span> pairs o <span class="org-haskell-operator">++</span> <span class="org-string">"}"</span>
  <span class="org-haskell-keyword">where</span> pairs <span class="org-haskell-constructor">[]</span> <span class="org-haskell-operator">=</span> <span class="org-string">""</span>
        pairs ps <span class="org-haskell-operator">=</span> intercalate <span class="org-string">", "</span> (map renderPair ps)
        renderPair (k<span class="org-haskell-operator">,</span>v)   <span class="org-haskell-operator">=</span> show k <span class="org-haskell-operator">++</span> <span class="org-string">": "</span> <span class="org-haskell-operator">++</span> renderJValue v

<span class="org-haskell-definition">renderJValue</span> (<span class="org-haskell-constructor">JArray</span> a) <span class="org-haskell-operator">=</span> <span class="org-string">"["</span> <span class="org-haskell-operator">++</span> values a <span class="org-haskell-operator">++</span> <span class="org-string">"]"</span>
  <span class="org-haskell-keyword">where</span> values <span class="org-haskell-constructor">[]</span> <span class="org-haskell-operator">=</span> <span class="org-string">""</span>
        values vs <span class="org-haskell-operator">=</span> intercalate <span class="org-string">", "</span> (map renderJValue vs)

<span class="org-comment-delimiter">-- </span><span class="org-comment">Good Haskell style involves separating pure code from code that</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">performs I/O. (Real World Haskell) </span>
<span class="org-comment-delimiter">--</span>
<span class="org-function-name">putJValue</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">putJValue</span> v <span class="org-haskell-operator">=</span> putStrLn (renderJValue v)
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"></pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-4-4" class="outline-4">
<h4 id="sec-1-4-4"><span class="section-number-4">1.4.4</span> PrettyJSON.hs</h4>
<div class="outline-text-4" id="text-1-4-4">
<p>
Page: 119 <a href="rwh/ch05/PrettyJSON.hs">rwh/ch05/PrettyJSON.hs</a> 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-function-name">renderJValue</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">JValue</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Doc</span>
<span class="org-haskell-definition">renderJValue</span> (<span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">True</span>)  <span class="org-haskell-operator">=</span> text <span class="org-string">"true"</span>
<span class="org-haskell-definition">renderJValue</span> (<span class="org-haskell-constructor">JBool</span> <span class="org-haskell-constructor">False</span>) <span class="org-haskell-operator">=</span> text <span class="org-string">"false"</span>
<span class="org-haskell-definition">renderJValue</span> <span class="org-haskell-constructor">JNull</span>         <span class="org-haskell-operator">=</span> text <span class="org-string">"null"</span>
<span class="org-haskell-definition">renderJValue</span> (<span class="org-haskell-constructor">JNumber</span> num) <span class="org-haskell-operator">=</span> double num
<span class="org-haskell-definition">renderJValue</span> (<span class="org-haskell-constructor">JString</span> str) <span class="org-haskell-operator">=</span> string str
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> Chapter 8  - Efficient File Processing, Regular Expressions, and Filename Matching</h3>
<div class="outline-text-3" id="text-1-5">
</div><div id="outline-container-sec-1-5-1" class="outline-4">
<h4 id="sec-1-5-1"><span class="section-number-4">1.5.1</span> ElfMagic.hs</h4>
<div class="outline-text-4" id="text-1-5-1">
<p>
Page 194. <a href="rwh/ch08/ElfMagic.hs">rwh/ch08/ElfMagic.hs</a>  
</p>

<p>
This function tests if the file is a Unix ELF executable that are
recognized by its magic number. 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">import</span> <span class="org-haskell-keyword">qualified</span> <span class="org-haskell-constructor">Data.ByteString.Lazy</span> <span class="org-haskell-keyword">as</span> <span class="org-haskell-constructor">L</span>

<span class="org-function-name">hasElfMagic</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Bool</span>
<span class="org-haskell-definition">hasElfMagic</span> content <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>take 4 content <span class="org-haskell-operator">==</span> elfMagic
    <span class="org-haskell-keyword">where</span> elfMagic <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>pack [0x7f<span class="org-haskell-operator">,</span> 0x45<span class="org-haskell-operator">,</span> 0x4c<span class="org-haskell-operator">,</span> 0x46]

<span class="org-function-name">isElfFile</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">FilePath</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">Bool</span>
<span class="org-haskell-definition">isElfFile</span> path <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
  content <span class="org-haskell-operator">&lt;-</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>readFile path
  return (hasElfMagic content)
</pre>
</div>

<p>
Running 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-constructor">GHCi</span><span class="org-haskell-operator">,</span> version 7.10<span class="org-haskell-operator">.</span>2<span class="org-haskell-constructor">:</span> http<span class="org-haskell-constructor">://</span>www<span class="org-haskell-operator">.</span>haskell<span class="org-haskell-operator">.</span>org<span class="org-haskell-operator">/</span>ghc<span class="org-haskell-operator">/</span>  <span class="org-haskell-constructor">:?</span> for help
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"ch08/ElfMagic.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( ch08<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">ElfMagic</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t hasElfMagic 
<span class="org-function-name">hasElfMagic</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Bool</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 


<span class="org-haskell-operator">&gt;&gt;&gt;</span> file <span class="org-haskell-operator">&lt;-</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>readFile <span class="org-string">"/bin/sh"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t file
<span class="org-function-name">file</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> hasElfMagic file
<span class="org-haskell-constructor">True</span>

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>take 10 file
<span class="org-string">"\DELELF\STX\SOH\SOH\NUL\NUL\NUL"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 


<span class="org-haskell-operator">&gt;&gt;&gt;</span> file <span class="org-haskell-operator">&lt;-</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>readFile <span class="org-string">"/etc/issue"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> file
<span class="org-string">"Arch Linux \\r (\\l)\n\n"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> hasElfMagic file
<span class="org-haskell-constructor">False</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-keyword">import</span> <span class="org-haskell-keyword">qualified</span> <span class="org-haskell-constructor">System.Directory</span> <span class="org-haskell-keyword">as</span> <span class="org-haskell-constructor">SD</span>


<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t isElfFile 
<span class="org-function-name">isElfFile</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">FilePath</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">Bool</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> isElfFile <span class="org-string">"/bin/sh"</span>
<span class="org-haskell-constructor">True</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> isElfFile <span class="org-string">"/etc/fstab"</span>
<span class="org-haskell-constructor">False</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">SD</span><span class="org-haskell-operator">.</span>setCurrentDirectory <span class="org-string">"/bin"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">SD</span><span class="org-haskell-operator">.</span>getCurrentDirectory 
<span class="org-string">"/usr/bin"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> files <span class="org-haskell-operator">&lt;-</span> <span class="org-haskell-constructor">SD</span><span class="org-haskell-operator">.</span>getDirectoryContents <span class="org-string">"/bin"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t files
<span class="org-function-name">files</span> <span class="org-haskell-operator">::</span> [<span class="org-haskell-constructor">FilePath</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> take 4 files
[<span class="org-string">"."</span><span class="org-haskell-operator">,</span><span class="org-string">".."</span><span class="org-haskell-operator">,</span><span class="org-string">"install-info"</span><span class="org-haskell-operator">,</span><span class="org-string">"update-desktop-database"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-keyword">let</span> flist <span class="org-haskell-operator">=</span> drop 2 files
<span class="org-haskell-operator">&gt;&gt;&gt;</span> take 4 flist
[<span class="org-string">"install-info"</span><span class="org-haskell-operator">,</span><span class="org-string">"update-desktop-database"</span><span class="org-haskell-operator">,</span><span class="org-string">"libinput-list-devices"</span><span class="org-haskell-operator">,</span><span class="org-string">"visudo"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t isElfFile 
<span class="org-function-name">isElfFile</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">FilePath</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">Bool</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t filter
<span class="org-function-name">filter</span> <span class="org-haskell-operator">::</span> (a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Bool</span>) <span class="org-haskell-operator">-&gt;</span> [a] <span class="org-haskell-operator">-&gt;</span> [a]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> filter isElfFile flist

<span class="org-haskell-operator">&lt;</span>interactive<span class="org-haskell-operator">&gt;:</span>83<span class="org-haskell-constructor">:</span>8<span class="org-haskell-constructor">:</span>
    <span class="org-haskell-constructor">Couldn't</span> match <span class="org-haskell-keyword">type</span> <span class="org-haskell-operator">&#8216;</span><span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">Bool</span><span class="org-haskell-operator">&#8217;</span> with <span class="org-haskell-operator">&#8216;</span><span class="org-haskell-constructor">Bool</span><span class="org-haskell-operator">&#8217;</span>
    <span class="org-haskell-constructor">Expected</span> <span class="org-haskell-keyword">type</span><span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">FilePath</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Bool</span>
      <span class="org-haskell-constructor">Actual</span> <span class="org-haskell-keyword">type</span><span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">FilePath</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">Bool</span>
    <span class="org-haskell-constructor">In</span> the first argument <span class="org-haskell-keyword">of</span> <span class="org-haskell-operator">&#8216;</span>filter<span class="org-haskell-operator">&#8217;,</span> namely <span class="org-haskell-operator">&#8216;</span>isElfFile<span class="org-haskell-operator">&#8217;</span>
    <span class="org-haskell-constructor">In</span> the expression<span class="org-haskell-constructor">:</span> filter isElfFile flist
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Control.Monad</span> (filterM)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t filterM
<span class="org-function-name">filterM</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Monad</span> m <span class="org-haskell-operator">=&gt;</span> (a <span class="org-haskell-operator">-&gt;</span> m <span class="org-haskell-constructor">Bool</span>) <span class="org-haskell-operator">-&gt;</span> [a] <span class="org-haskell-operator">-&gt;</span> m [a]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> filesOnly <span class="org-haskell-operator">&lt;-</span> filterM <span class="org-haskell-constructor">SD</span><span class="org-haskell-operator">.</span>doesFileExist flist
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> take 4 filesOnly 
[<span class="org-string">"install-info"</span><span class="org-haskell-operator">,</span><span class="org-string">"update-desktop-database"</span><span class="org-haskell-operator">,</span><span class="org-string">"libinput-list-devices"</span><span class="org-haskell-operator">,</span><span class="org-string">"visudo"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 


<span class="org-haskell-operator">&gt;&gt;&gt;</span> filterM isElfFile  (take 30 filesOnly ) <span class="org-haskell-operator">&gt;&gt;=</span> mapM_ putStrLn 
install<span class="org-haskell-definition">-</span>info
update<span class="org-haskell-definition">-</span>desktop<span class="org-haskell-operator">-</span>database
libinput<span class="org-haskell-definition">-</span>list<span class="org-haskell-operator">-</span>devices
visudo
suexec
jack_wait
dirname
j2k_dump
json<span class="org-haskell-definition">-</span>glib<span class="org-haskell-operator">-</span>format
runlevel
chacl
eu<span class="org-haskell-definition">-</span>addr2line
c<span class="org-haskell-definition">++</span>
git
gcov
ionice
lircd
<span class="org-haskell-operator">...</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-5-2" class="outline-4">
<h4 id="sec-1-5-2"><span class="section-number-4">1.5.2</span> HighestClose.hs</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
Page 196. <a href="rwh/ch08/HighestClose.hs">rwh/ch08/HighestClose.hs</a> 
</p>


<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">import</span> <span class="org-haskell-keyword">qualified</span> <span class="org-haskell-constructor">Data.ByteString.Lazy.Char8</span> <span class="org-haskell-keyword">as</span> <span class="org-haskell-constructor">L</span>

<span class="org-haskell-definition">closing</span> <span class="org-haskell-operator">=</span> readPrice <span class="org-haskell-operator">.</span> (<span class="org-haskell-operator">!!</span>4) <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>split <span class="org-string">','</span>

<span class="org-function-name">readPrice</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Int</span>
<span class="org-haskell-definition">readPrice</span> str <span class="org-haskell-operator">=</span>
    <span class="org-haskell-keyword">case</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>readInt str <span class="org-haskell-keyword">of</span>
      <span class="org-haskell-constructor">Nothing</span>             <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span>
      <span class="org-haskell-constructor">Just</span> (dollars<span class="org-haskell-operator">,</span>rest) <span class="org-haskell-operator">-&gt;</span>
        <span class="org-haskell-keyword">case</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>readInt (<span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>tail rest) <span class="org-haskell-keyword">of</span>
          <span class="org-haskell-constructor">Nothing</span>           <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span>
          <span class="org-haskell-constructor">Just</span> (cents<span class="org-haskell-operator">,</span>more) <span class="org-haskell-operator">-&gt;</span>
            <span class="org-haskell-constructor">Just</span> (dollars <span class="org-haskell-operator">*</span> 100 <span class="org-haskell-operator">+</span> cents)


<span class="org-haskell-definition">highestClose</span> <span class="org-haskell-operator">=</span> maximum <span class="org-haskell-operator">.</span> (<span class="org-haskell-constructor">Nothing:</span>) <span class="org-haskell-operator">.</span> map closing <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines

<span class="org-haskell-definition">highestCloseFrom</span> path <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
    contents <span class="org-haskell-operator">&lt;-</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>readFile path
    print (highestClose contents)
</pre>
</div>


<p>
File: <a href="rwh/ch08/prices.csv">rwh/ch08/prices.csv</a> 
</p>

<div class="org-src-container">

<pre class="src src-csv" id="prices.csv">Date,Open,High,Low,Close,Volume,Adj Close
2008-08-01,20.09,20.12,19.53,19.80,19777000,19.80
2008-06-30,21.12,21.20,20.60,20.66,17173500,20.66
2008-05-30,27.07,27.10,26.63,26.76,17754100,26.76
2008-04-30,27.17,27.78,26.76,27.41,30597400,27.41
</pre>
</div>


<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"rwh/ch08/HighestClose.hs"</span> 
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( rwh<span class="org-haskell-operator">/</span>ch08<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">HighestClose</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> highestCloseFrom <span class="org-string">"rwh/ch08/prices.csv"</span>
<span class="org-haskell-constructor">Just</span> 2741
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> contents <span class="org-haskell-operator">&lt;-</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>readFile <span class="org-string">"rwh/ch08/prices.csv"</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t contents
<span class="org-function-name">contents</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-comment-delimiter">-- </span><span class="org-comment">The output was formatted manually to fit in the </span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">screen. </span>
<span class="org-comment-delimiter">--</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> tail <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines contents 
[<span class="org-string">"2008-08-01,20.09,20.12,19.53,19.80,19777000,19.80"</span><span class="org-haskell-operator">,</span>
<span class="org-string">"2008-06-30,21.12,21.20,20.60,20.66,17173500,20.66"</span><span class="org-haskell-operator">,</span>
<span class="org-string">"2008-05-30,27.07,27.10,26.63,26.76,17754100,26.76"</span><span class="org-haskell-operator">,</span>
<span class="org-string">"2008-04-30,27.17,27.78,26.76,27.41,30597400,27.41"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> mapM_ (<span class="org-haskell-operator">\</span> x <span class="org-haskell-operator">-&gt;</span> putStrLn (show x)) <span class="org-haskell-operator">$</span> tail <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines contents 
<span class="org-string">"2008-08-01,20.09,20.12,19.53,19.80,19777000,19.80"</span>
<span class="org-string">"2008-06-30,21.12,21.20,20.60,20.66,17173500,20.66"</span>
<span class="org-string">"2008-05-30,27.07,27.10,26.63,26.76,17754100,26.76"</span>
<span class="org-string">"2008-04-30,27.17,27.78,26.76,27.41,30597400,27.41"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> mapM_ (<span class="org-haskell-operator">\</span> x <span class="org-haskell-operator">-&gt;</span> putStrLn (show x)) <span class="org-haskell-operator">$</span> map (<span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>split <span class="org-string">','</span>)  <span class="org-haskell-operator">$</span> tail <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines contents 
[<span class="org-string">"2008-08-01"</span><span class="org-haskell-operator">,</span><span class="org-string">"20.09"</span><span class="org-haskell-operator">,</span><span class="org-string">"20.12"</span><span class="org-haskell-operator">,</span><span class="org-string">"19.53"</span><span class="org-haskell-operator">,</span><span class="org-string">"19.80"</span><span class="org-haskell-operator">,</span><span class="org-string">"19777000"</span><span class="org-haskell-operator">,</span><span class="org-string">"19.80"</span>]
[<span class="org-string">"2008-06-30"</span><span class="org-haskell-operator">,</span><span class="org-string">"21.12"</span><span class="org-haskell-operator">,</span><span class="org-string">"21.20"</span><span class="org-haskell-operator">,</span><span class="org-string">"20.60"</span><span class="org-haskell-operator">,</span><span class="org-string">"20.66"</span><span class="org-haskell-operator">,</span><span class="org-string">"17173500"</span><span class="org-haskell-operator">,</span><span class="org-string">"20.66"</span>]
[<span class="org-string">"2008-05-30"</span><span class="org-haskell-operator">,</span><span class="org-string">"27.07"</span><span class="org-haskell-operator">,</span><span class="org-string">"27.10"</span><span class="org-haskell-operator">,</span><span class="org-string">"26.63"</span><span class="org-haskell-operator">,</span><span class="org-string">"26.76"</span><span class="org-haskell-operator">,</span><span class="org-string">"17754100"</span><span class="org-haskell-operator">,</span><span class="org-string">"26.76"</span>]
[<span class="org-string">"2008-04-30"</span><span class="org-haskell-operator">,</span><span class="org-string">"27.17"</span><span class="org-haskell-operator">,</span><span class="org-string">"27.78"</span><span class="org-haskell-operator">,</span><span class="org-string">"26.76"</span><span class="org-haskell-operator">,</span><span class="org-string">"27.41"</span><span class="org-haskell-operator">,</span><span class="org-string">"30597400"</span><span class="org-haskell-operator">,</span><span class="org-string">"27.41"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-comment-delimiter">-- </span><span class="org-comment">Adj close </span>
<span class="org-comment-delimiter">--</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> map (<span class="org-haskell-operator">!!</span>4) <span class="org-haskell-operator">$</span> map (<span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>split <span class="org-string">','</span>)  <span class="org-haskell-operator">$</span> tail <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines contents 
[<span class="org-string">"19.80"</span><span class="org-haskell-operator">,</span><span class="org-string">"20.66"</span><span class="org-haskell-operator">,</span><span class="org-string">"26.76"</span><span class="org-haskell-operator">,</span><span class="org-string">"27.41"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-comment-delimiter">-- </span><span class="org-comment">Optmization with function composition </span>
<span class="org-comment-delimiter">-- </span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> map ( (<span class="org-haskell-operator">!!</span>4) <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>split <span class="org-string">','</span>)  <span class="org-haskell-operator">$</span> tail <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines contents 
[<span class="org-string">"19.80"</span><span class="org-haskell-operator">,</span><span class="org-string">"20.66"</span><span class="org-haskell-operator">,</span><span class="org-string">"26.76"</span><span class="org-haskell-operator">,</span><span class="org-string">"27.41"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> map ( (<span class="org-haskell-operator">!!</span>4) <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>split <span class="org-string">','</span>)  <span class="org-haskell-operator">.</span> tail <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines <span class="org-haskell-operator">$</span> contents 
[<span class="org-string">"19.80"</span><span class="org-haskell-operator">,</span><span class="org-string">"20.66"</span><span class="org-haskell-operator">,</span><span class="org-string">"26.76"</span><span class="org-haskell-operator">,</span><span class="org-string">"27.41"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-keyword">let</span> readLByteStringMaybe  <span class="org-haskell-operator">=</span> readMaybe <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>unpack 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t readLByteStringMaybe
<span class="org-function-name">readLByteStringMaybe</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Read</span> a <span class="org-haskell-operator">=&gt;</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> a
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> map (<span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> readLByteStringMaybe x <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Double</span>) <span class="org-haskell-operator">$</span> map ( (<span class="org-haskell-operator">!!</span>4) <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>split <span class="org-string">','</span>)  <span class="org-haskell-operator">.</span> tail <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines <span class="org-haskell-operator">$</span> contents 
[<span class="org-haskell-constructor">Just</span> 19.8<span class="org-haskell-operator">,</span><span class="org-haskell-constructor">Just</span> 20.66<span class="org-haskell-operator">,</span><span class="org-haskell-constructor">Just</span> 26.76<span class="org-haskell-operator">,</span><span class="org-haskell-constructor">Just</span> 27.41]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> map ((<span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> readLByteStringMaybe x <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Double</span>) <span class="org-haskell-operator">.</span> (<span class="org-haskell-operator">!!</span>4) <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>split <span class="org-string">','</span>)  <span class="org-haskell-operator">.</span> tail <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines <span class="org-haskell-operator">$</span> contents 
[<span class="org-haskell-constructor">Just</span> 19.8<span class="org-haskell-operator">,</span><span class="org-haskell-constructor">Just</span> 20.66<span class="org-haskell-operator">,</span><span class="org-haskell-constructor">Just</span> 26.76<span class="org-haskell-operator">,</span><span class="org-haskell-constructor">Just</span> 27.41]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-comment-delimiter">-- </span><span class="org-comment">If any number fail to be parsed the whole column will fail, </span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">it will return Nothing </span>
<span class="org-comment-delimiter">--</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> sequence <span class="org-haskell-operator">$</span> map ((<span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> readLByteStringMaybe x <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Double</span>) <span class="org-haskell-operator">.</span> (<span class="org-haskell-operator">!!</span>4) <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>split <span class="org-string">','</span>)  <span class="org-haskell-operator">.</span> tail <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines <span class="org-haskell-operator">$</span> contents 
<span class="org-haskell-constructor">Just</span> [19.8<span class="org-haskell-operator">,</span>20.66<span class="org-haskell-operator">,</span>26.76<span class="org-haskell-operator">,</span>27.41]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 


<span class="org-haskell-operator">&gt;&gt;&gt;</span> fmap sum <span class="org-haskell-operator">$</span> sequence <span class="org-haskell-operator">$</span> map ((<span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> readLByteStringMaybe x <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Double</span>) <span class="org-haskell-operator">.</span> (<span class="org-haskell-operator">!!</span>4) <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>split <span class="org-string">','</span>)  <span class="org-haskell-operator">.</span> tail <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines <span class="org-haskell-operator">$</span> contents 
<span class="org-haskell-constructor">Just</span> 94.63
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-keyword">let</span> parseColumnDouble n <span class="org-haskell-operator">=</span>  sequence <span class="org-haskell-operator">.</span> map ((<span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> readLByteStringMaybe x <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Double</span>) <span class="org-haskell-operator">.</span> (<span class="org-haskell-operator">!!</span>n) <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>split <span class="org-string">','</span>)  <span class="org-haskell-operator">.</span> tail <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t parseColumnDouble
<span class="org-function-name">parseColumnDouble</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> [<span class="org-haskell-constructor">Double</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-comment-delimiter">--</span><span class="org-comment">- Multiline function composition </span>
<span class="org-comment-delimiter">--</span><span class="org-comment">- </span>
<span class="org-comment-delimiter">--</span><span class="org-comment">- </span>
<span class="org-comment-delimiter">--</span><span class="org-comment">-</span>
<span class="org-haskell-constructor">:</span>set <span class="org-haskell-operator">+</span>m  <span class="org-comment-delimiter">-- </span><span class="org-comment">Allow multi line paste in the repl.</span>

<span class="org-haskell-constructor">:</span>{
<span class="org-haskell-keyword">let</span> parseColumnDouble n <span class="org-haskell-operator">=</span>
      sequence
      <span class="org-haskell-operator">.</span> map ((<span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> readLByteStringMaybe x <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Double</span>)
             <span class="org-haskell-operator">.</span> (<span class="org-haskell-operator">!!</span>n)
             <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>split <span class="org-string">','</span>
            )
             <span class="org-haskell-operator">.</span> tail
             <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines            
<span class="org-haskell-constructor">:</span>}


<span class="org-haskell-operator">&gt;&gt;&gt;</span> parseColumnDouble 0 contents 
<span class="org-haskell-constructor">Nothing</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parseColumnDouble 1 contents 
<span class="org-haskell-constructor">Just</span> [20.09<span class="org-haskell-operator">,</span>21.12<span class="org-haskell-operator">,</span>27.07<span class="org-haskell-operator">,</span>27.17]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parseColumnDouble 2 contents 
<span class="org-haskell-constructor">Just</span> [20.12<span class="org-haskell-operator">,</span>21.2<span class="org-haskell-operator">,</span>27.1<span class="org-haskell-operator">,</span>27.78]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parseColumnDouble 3 contents 
<span class="org-haskell-constructor">Just</span> [19.53<span class="org-haskell-operator">,</span>20.6<span class="org-haskell-operator">,</span>26.63<span class="org-haskell-operator">,</span>26.76]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parseColumnDouble 4 contents 
<span class="org-haskell-constructor">Just</span> [19.8<span class="org-haskell-operator">,</span>20.66<span class="org-haskell-operator">,</span>26.76<span class="org-haskell-operator">,</span>27.41]

<span class="org-comment-delimiter">-- </span><span class="org-comment">Year </span>
<span class="org-comment-delimiter">--</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> map (<span class="org-haskell-operator">!!</span>0) <span class="org-haskell-operator">$</span> map (<span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>split <span class="org-string">','</span>)  <span class="org-haskell-operator">$</span> tail <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>lines contents 
[<span class="org-string">"2008-08-01"</span><span class="org-haskell-operator">,</span><span class="org-string">"2008-06-30"</span><span class="org-haskell-operator">,</span><span class="org-string">"2008-05-30"</span><span class="org-haskell-operator">,</span><span class="org-string">"2008-04-30"</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 


<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6"><span class="section-number-3">1.6</span> Chapter 10 - Code Case Study: Parsing a Binary Data Format</h3>
<div class="outline-text-3" id="text-1-6">
</div><div id="outline-container-sec-1-6-1" class="outline-4">
<h4 id="sec-1-6-1"><span class="section-number-4">1.6.1</span> PNM.hs</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
Page 246 - File: <a href="rwh/ch10/PNM.hs">rwh/ch10/PNM.hs</a> 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">import</span> <span class="org-haskell-keyword">qualified</span> <span class="org-haskell-constructor">Data.ByteString.Lazy.Char8</span> <span class="org-haskell-keyword">as</span> <span class="org-haskell-constructor">L8</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-keyword">qualified</span> <span class="org-haskell-constructor">Data.ByteString.Lazy</span> <span class="org-haskell-keyword">as</span> <span class="org-haskell-constructor">L</span> 
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.Char</span> (isSpace)

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">Greymap</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Greymap</span> {
      greyWidth  <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span>
    <span class="org-haskell-operator">,</span> greyHeight <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span>
    <span class="org-haskell-operator">,</span> greyMax    <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span>
    <span class="org-haskell-operator">,</span> greyData   <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span>
    } <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Eq</span>)

<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Show</span> <span class="org-haskell-constructor">Greymap</span> <span class="org-haskell-keyword">where</span>
    show (<span class="org-haskell-constructor">Greymap</span> w h m <span class="org-haskell-keyword">_</span>) <span class="org-haskell-operator">=</span> <span class="org-string">"Greymap "</span> <span class="org-haskell-operator">++</span> show w <span class="org-haskell-operator">++</span> <span class="org-string">"x"</span> <span class="org-haskell-operator">++</span> show h <span class="org-haskell-operator">++</span>
                             <span class="org-string">" "</span> <span class="org-haskell-operator">++</span> show m

<span class="org-function-name">parseP5</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> (<span class="org-haskell-constructor">Greymap</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">L.ByteString</span>)
<span class="org-haskell-definition">parseP5</span> s <span class="org-haskell-operator">=</span>
  <span class="org-haskell-keyword">case</span> matchHeader (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"P5"</span>) s <span class="org-haskell-keyword">of</span>
    <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span>
    <span class="org-haskell-constructor">Just</span> s1 <span class="org-haskell-operator">-&gt;</span>
      <span class="org-haskell-keyword">case</span> getNat s1 <span class="org-haskell-keyword">of</span>
        <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span>
        <span class="org-haskell-constructor">Just</span> (width<span class="org-haskell-operator">,</span> s2) <span class="org-haskell-operator">-&gt;</span>
          <span class="org-haskell-keyword">case</span> getNat (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>dropWhile isSpace s2) <span class="org-haskell-keyword">of</span>
            <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span>
            <span class="org-haskell-constructor">Just</span> (height<span class="org-haskell-operator">,</span> s3) <span class="org-haskell-operator">-&gt;</span>
              <span class="org-haskell-keyword">case</span> getNat (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>dropWhile isSpace s3) <span class="org-haskell-keyword">of</span>
                <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span>
                <span class="org-haskell-constructor">Just</span> (maxGrey<span class="org-haskell-operator">,</span> s4)
                  <span class="org-haskell-operator">|</span> maxGrey <span class="org-haskell-operator">&gt;</span> 255 <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span>
                  <span class="org-haskell-operator">|</span> otherwise <span class="org-haskell-operator">-&gt;</span>
                      <span class="org-haskell-keyword">case</span> getBytes 1 s4 <span class="org-haskell-keyword">of</span>
                        <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span>
                        <span class="org-haskell-constructor">Just</span> (<span class="org-haskell-keyword">_</span><span class="org-haskell-operator">,</span> s5) <span class="org-haskell-operator">-&gt;</span>
                          <span class="org-haskell-keyword">case</span> getBytes (width <span class="org-haskell-operator">*</span> height) s5 <span class="org-haskell-keyword">of</span>
                            <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span>
                            <span class="org-haskell-constructor">Just</span> (bitmap<span class="org-haskell-operator">,</span> s6) <span class="org-haskell-operator">-&gt;</span>
                              <span class="org-haskell-constructor">Just</span> (<span class="org-haskell-constructor">Greymap</span> width height maxGrey bitmap<span class="org-haskell-operator">,</span> s6)


<span class="org-function-name">matchHeader</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">L.ByteString</span>
<span class="org-haskell-definition">matchHeader</span> prefix str
    <span class="org-haskell-operator">|</span> prefix <span class="org-haskell-operator">`L8.isPrefixOf`</span> str
        <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>dropWhile isSpace (<span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>drop (<span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>length prefix) str))
    <span class="org-haskell-operator">|</span> otherwise
        <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span>


<span class="org-function-name">getNat</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> (<span class="org-haskell-constructor">Int</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">L.ByteString</span>)
<span class="org-haskell-definition">getNat</span> s <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">case</span> <span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>readInt s <span class="org-haskell-keyword">of</span>
             <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span>
             <span class="org-haskell-constructor">Just</span> (num<span class="org-haskell-operator">,</span>rest)
                 <span class="org-haskell-operator">|</span> num <span class="org-haskell-operator">&lt;=</span> 0    <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Nothing</span>
                 <span class="org-haskell-operator">|</span> otherwise <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Just</span> (fromIntegral num<span class="org-haskell-operator">,</span> rest)

<span class="org-function-name">getBytes</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> (<span class="org-haskell-constructor">L.ByteString</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">L.ByteString</span>)
<span class="org-haskell-definition">getBytes</span> n str <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">let</span> count           <span class="org-haskell-operator">=</span> fromIntegral n
                     both<span class="org-haskell-operator">@</span>(prefix<span class="org-haskell-operator">,</span><span class="org-haskell-keyword">_</span>) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>splitAt count str
                 <span class="org-haskell-keyword">in</span> <span class="org-haskell-keyword">if</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>length prefix <span class="org-haskell-operator">&lt;</span> count
                    <span class="org-haskell-keyword">then</span> <span class="org-haskell-constructor">Nothing</span>
                    <span class="org-haskell-keyword">else</span> <span class="org-haskell-constructor">Just</span> both
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"rwh/ch10/PNM.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( rwh<span class="org-haskell-operator">/</span>ch10<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">PNM</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> content <span class="org-haskell-operator">&lt;-</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>readFile <span class="org-string">"rwh/ch10/bird.pgm"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>take 30 content
<span class="org-string">"P5\n321 481\n255\n4`oxyrxvuuuuuuu"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parseP5 content
<span class="org-haskell-constructor">Just</span> (<span class="org-haskell-constructor">Greymap</span> 321x481 255<span class="org-haskell-operator">,</span><span class="org-string">""</span>)
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>

<p>
Test files:
</p>

<ul class="org-ul">
<li><a href="rwh/ch10/bird.pgm">rwh/ch10/bird.pgm</a>
</li>

<li>rwh/ch10/bird.png 
</li>
</ul>


<div class="figure">
<p><img src="rwh/ch10/bird.png" alt="bird.png" /> 
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-6-2" class="outline-4">
<h4 id="sec-1-6-2"><span class="section-number-4">1.6.2</span> Parse.hs</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
Page 240; 250 - File: <a href="rwh/ch10/Parse.hs">rwh/ch10/Parse.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">import</span> <span class="org-haskell-keyword">qualified</span> <span class="org-haskell-constructor">Data.ByteString.Lazy.Char8</span> <span class="org-haskell-keyword">as</span> <span class="org-haskell-constructor">L8</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-keyword">qualified</span> <span class="org-haskell-constructor">Data.ByteString.Lazy</span> <span class="org-haskell-keyword">as</span> <span class="org-haskell-constructor">L</span> 
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.Word</span> (<span class="org-haskell-constructor">Word8</span>)
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.Int</span> (<span class="org-haskell-constructor">Int64</span>)
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.Char</span> (chr<span class="org-haskell-operator">,</span> isDigit<span class="org-haskell-operator">,</span> isSpace)
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Control.Applicative</span> ((<span class="org-haskell-operator">&lt;$&gt;</span>))

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">ParseState</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">ParseState</span> {
      string <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span>
    <span class="org-haskell-operator">,</span> offset <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int64</span>           <span class="org-comment-delimiter">-- </span><span class="org-comment">imported from Data.Int</span>
    } <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Show</span>)

<span class="org-function-name">simpleParse</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">ParseState</span> <span class="org-haskell-operator">-&gt;</span> (a<span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">ParseState</span>)
<span class="org-haskell-definition">simpleParse</span> <span class="org-haskell-operator">=</span> undefined

<span class="org-function-name">betterParse</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">ParseState</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Either</span> <span class="org-haskell-constructor">String</span> (a<span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">ParseState</span>)
<span class="org-haskell-definition">betterParse</span> <span class="org-haskell-operator">=</span> undefined

<span class="org-haskell-keyword">newtype</span> <span class="org-haskell-constructor">Parse</span> a <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Parse</span> {
      runParse <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">ParseState</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Either</span> <span class="org-haskell-constructor">String</span> (a<span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">ParseState</span>)
    }

<span class="org-function-name">identity</span> <span class="org-haskell-operator">::</span> a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Parse</span> a
<span class="org-haskell-definition">identity</span> a <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Parse</span> (<span class="org-haskell-operator">\</span>s <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Right</span> (a<span class="org-haskell-operator">,</span> s))


<span class="org-function-name">parse</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Parse</span> a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Either</span> <span class="org-haskell-constructor">String</span> a
<span class="org-haskell-definition">parse</span> parser initState
    <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">case</span> runParse parser (<span class="org-haskell-constructor">ParseState</span> initState 0) <span class="org-haskell-keyword">of</span>
        <span class="org-haskell-constructor">Left</span> err          <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Left</span> err
        <span class="org-haskell-constructor">Right</span> (result<span class="org-haskell-operator">,</span> <span class="org-haskell-keyword">_</span>) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Right</span> result

<span class="org-function-name">modifyOffset</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">ParseState</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int64</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">ParseState</span>
<span class="org-haskell-definition">modifyOffset</span> initState newOffset <span class="org-haskell-operator">=</span>
    initState { offset <span class="org-haskell-operator">=</span> newOffset }

<span class="org-function-name">getState</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Parse</span> <span class="org-haskell-constructor">ParseState</span>
<span class="org-haskell-definition">getState</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Parse</span> (<span class="org-haskell-operator">\</span>s <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Right</span> (s<span class="org-haskell-operator">,</span> s))

<span class="org-function-name">putState</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">ParseState</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Parse</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">putState</span> s <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Parse</span> (<span class="org-haskell-operator">\</span><span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Right</span> (<span class="org-haskell-constructor">()</span><span class="org-haskell-operator">,</span> s))

<span class="org-function-name">bail</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Parse</span> a
<span class="org-haskell-definition">bail</span> err <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Parse</span> <span class="org-haskell-operator">$</span> <span class="org-haskell-operator">\</span>s <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Left</span> <span class="org-haskell-operator">$</span>
           <span class="org-string">"byte offset "</span> <span class="org-haskell-operator">++</span> show (offset s) <span class="org-haskell-operator">++</span> <span class="org-string">": "</span> <span class="org-haskell-operator">++</span> err

(<span class="org-haskell-definition">==&gt;</span>) <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Parse</span> a <span class="org-haskell-operator">-&gt;</span> (a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Parse</span> b) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Parse</span> b
<span class="org-haskell-definition">firstParser</span> <span class="org-haskell-definition">==&gt;</span> secondParser  <span class="org-haskell-operator">=</span>  <span class="org-haskell-constructor">Parse</span> chainedParser
  <span class="org-haskell-keyword">where</span> chainedParser initState   <span class="org-haskell-operator">=</span>
          <span class="org-haskell-keyword">case</span> runParse firstParser initState <span class="org-haskell-keyword">of</span>
            <span class="org-haskell-constructor">Left</span> errMessage <span class="org-haskell-operator">-&gt;</span>
                <span class="org-haskell-constructor">Left</span> errMessage
            <span class="org-haskell-constructor">Right</span> (firstResult<span class="org-haskell-operator">,</span> newState) <span class="org-haskell-operator">-&gt;</span>
                runParse (secondParser firstResult) newState


<span class="org-function-name">parseByte</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Parse</span> <span class="org-haskell-constructor">Word8</span>
<span class="org-haskell-definition">parseByte</span> <span class="org-haskell-operator">=</span>
    getState <span class="org-haskell-operator">==&gt;</span> <span class="org-haskell-operator">\</span>initState <span class="org-haskell-operator">-&gt;</span>
    <span class="org-haskell-keyword">case</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>uncons (string initState) <span class="org-haskell-keyword">of</span>
      <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">-&gt;</span>
          bail <span class="org-string">"no more input"</span>
      <span class="org-haskell-constructor">Just</span> (byte<span class="org-haskell-operator">,</span>remainder) <span class="org-haskell-operator">-&gt;</span>
          putState newState <span class="org-haskell-operator">==&gt;</span> <span class="org-haskell-operator">\</span><span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span>
          identity byte
        <span class="org-haskell-keyword">where</span> newState <span class="org-haskell-operator">=</span> initState { string <span class="org-haskell-operator">=</span> remainder<span class="org-haskell-operator">,</span>
                                     offset <span class="org-haskell-operator">=</span> newOffset }
              newOffset <span class="org-haskell-operator">=</span> offset initState <span class="org-haskell-operator">+</span> 1

<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Functor</span> <span class="org-haskell-constructor">Parse</span> <span class="org-haskell-keyword">where</span>
    fmap f parser <span class="org-haskell-operator">=</span> parser <span class="org-haskell-operator">==&gt;</span> <span class="org-haskell-operator">\</span>result <span class="org-haskell-operator">-&gt;</span>
                    identity (f result)

<span class="org-function-name">w2c</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Word8</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Char</span>
<span class="org-haskell-definition">w2c</span> <span class="org-haskell-operator">=</span> chr <span class="org-haskell-operator">.</span> fromIntegral

<span class="org-function-name">parseChar</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Parse</span> <span class="org-haskell-constructor">Char</span>
<span class="org-haskell-definition">parseChar</span> <span class="org-haskell-operator">=</span> w2c <span class="org-haskell-operator">&lt;$&gt;</span> parseByte

<span class="org-function-name">peekByte</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Parse</span> (<span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Word8</span>)
<span class="org-haskell-definition">peekByte</span> <span class="org-haskell-operator">=</span> (fmap fst <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>uncons <span class="org-haskell-operator">.</span> string) <span class="org-haskell-operator">&lt;$&gt;</span> getState

<span class="org-function-name">peekChar</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Parse</span> (<span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">Char</span>)
<span class="org-haskell-definition">peekChar</span> <span class="org-haskell-operator">=</span> fmap w2c <span class="org-haskell-operator">&lt;$&gt;</span> peekByte


<span class="org-function-name">parseWhile</span> <span class="org-haskell-operator">::</span> (<span class="org-haskell-constructor">Word8</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Bool</span>) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Parse</span> [<span class="org-haskell-constructor">Word8</span>]
<span class="org-haskell-definition">parseWhile</span> p <span class="org-haskell-operator">=</span> (fmap p <span class="org-haskell-operator">&lt;$&gt;</span> peekByte) <span class="org-haskell-operator">==&gt;</span> <span class="org-haskell-operator">\</span>mp <span class="org-haskell-operator">-&gt;</span>
               <span class="org-haskell-keyword">if</span> mp <span class="org-haskell-operator">==</span> <span class="org-haskell-constructor">Just</span> <span class="org-haskell-constructor">True</span>
               <span class="org-haskell-keyword">then</span> parseByte <span class="org-haskell-operator">==&gt;</span> <span class="org-haskell-operator">\</span>b <span class="org-haskell-operator">-&gt;</span>
                    (b<span class="org-haskell-constructor">:</span>) <span class="org-haskell-operator">&lt;$&gt;</span> parseWhile p
               <span class="org-haskell-keyword">else</span> identity <span class="org-haskell-constructor">[]</span>

<span class="org-haskell-definition">parseWhileVerbose</span> p <span class="org-haskell-operator">=</span>
    peekByte <span class="org-haskell-operator">==&gt;</span> <span class="org-haskell-operator">\</span>mc <span class="org-haskell-operator">-&gt;</span>
    <span class="org-haskell-keyword">case</span> mc <span class="org-haskell-keyword">of</span>
      <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">-&gt;</span> identity <span class="org-haskell-constructor">[]</span>
      <span class="org-haskell-constructor">Just</span> c <span class="org-haskell-operator">|</span> p c <span class="org-haskell-operator">-&gt;</span>
                 parseByte <span class="org-haskell-operator">==&gt;</span> <span class="org-haskell-operator">\</span>b <span class="org-haskell-operator">-&gt;</span>
                 parseWhileVerbose p <span class="org-haskell-operator">==&gt;</span> <span class="org-haskell-operator">\</span>bs <span class="org-haskell-operator">-&gt;</span>
                 identity (b<span class="org-haskell-constructor">:</span>bs)
             <span class="org-haskell-operator">|</span> otherwise <span class="org-haskell-operator">-&gt;</span>
                 identity <span class="org-haskell-constructor">[]</span>

<span class="org-function-name">parseWhileWith</span> <span class="org-haskell-operator">::</span> (<span class="org-haskell-constructor">Word8</span> <span class="org-haskell-operator">-&gt;</span> a) <span class="org-haskell-operator">-&gt;</span> (a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Bool</span>) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Parse</span> [a]
<span class="org-haskell-definition">parseWhileWith</span> f p <span class="org-haskell-operator">=</span> fmap f <span class="org-haskell-operator">&lt;$&gt;</span> parseWhile (p <span class="org-haskell-operator">.</span> f)

<span class="org-function-name">parseNat</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Parse</span> <span class="org-haskell-constructor">Int</span>
<span class="org-haskell-definition">parseNat</span> <span class="org-haskell-operator">=</span> parseWhileWith w2c isDigit <span class="org-haskell-operator">==&gt;</span> <span class="org-haskell-operator">\</span>digits <span class="org-haskell-operator">-&gt;</span>
           <span class="org-haskell-keyword">if</span> null digits
           <span class="org-haskell-keyword">then</span> bail <span class="org-string">"no more input"</span>
           <span class="org-haskell-keyword">else</span> <span class="org-haskell-keyword">let</span> n <span class="org-haskell-operator">=</span> read digits
                <span class="org-haskell-keyword">in</span> <span class="org-haskell-keyword">if</span> n <span class="org-haskell-operator">&lt;</span> 0
                   <span class="org-haskell-keyword">then</span> bail <span class="org-string">"integer overflow"</span>
                   <span class="org-haskell-keyword">else</span> identity n

(<span class="org-haskell-definition">==&gt;&amp;</span>) <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Parse</span> a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Parse</span> b <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Parse</span> b
<span class="org-haskell-definition">p</span> <span class="org-haskell-definition">==&gt;&amp;</span> f <span class="org-haskell-operator">=</span> p <span class="org-haskell-operator">==&gt;</span> <span class="org-haskell-operator">\</span><span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> f

<span class="org-function-name">skipSpaces</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Parse</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">skipSpaces</span> <span class="org-haskell-operator">=</span> parseWhileWith w2c isSpace <span class="org-haskell-operator">==&gt;&amp;</span> identity <span class="org-haskell-constructor">()</span>

<span class="org-function-name">assert</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Bool</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Parse</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">assert</span> <span class="org-haskell-constructor">True</span>  <span class="org-haskell-keyword">_</span>   <span class="org-haskell-operator">=</span> identity <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">assert</span> <span class="org-haskell-constructor">False</span> err <span class="org-haskell-operator">=</span> bail err

<span class="org-function-name">parseBytes</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Parse</span> <span class="org-haskell-constructor">L.ByteString</span>
<span class="org-haskell-definition">parseBytes</span> n <span class="org-haskell-operator">=</span>
    getState <span class="org-haskell-operator">==&gt;</span> <span class="org-haskell-operator">\</span>st <span class="org-haskell-operator">-&gt;</span>
    <span class="org-haskell-keyword">let</span> n' <span class="org-haskell-operator">=</span> fromIntegral n
        (h<span class="org-haskell-operator">,</span> t) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>splitAt n' (string st)
        st' <span class="org-haskell-operator">=</span> st { offset <span class="org-haskell-operator">=</span> offset st <span class="org-haskell-operator">+</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>length h<span class="org-haskell-operator">,</span> string <span class="org-haskell-operator">=</span> t }
    <span class="org-haskell-keyword">in</span> putState st' <span class="org-haskell-operator">==&gt;&amp;</span>
       assert (<span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>length h <span class="org-haskell-operator">==</span> n') <span class="org-string">"end of input"</span> <span class="org-haskell-operator">==&gt;&amp;</span>
       identity h
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"rwh/ch10/Parse.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( rwh<span class="org-haskell-operator">/</span>ch10<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">Parse</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t identity
<span class="org-function-name">identity</span> <span class="org-haskell-operator">::</span> a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Parse</span> a
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>info <span class="org-haskell-constructor">Parse</span>
<span class="org-haskell-keyword">newtype</span> <span class="org-haskell-constructor">Parse</span> a
  <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Parse</span> {runParse <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">ParseState</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Either</span> <span class="org-haskell-constructor">String</span> (a<span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">ParseState</span>)}
        <span class="org-comment-delimiter">-- </span><span class="org-comment">Defined at rwh/ch10/Parse.hs:18:1</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span><span class="org-haskell-keyword">type</span> parse (identity 1) undefined
<span class="org-haskell-definition">parse</span> (identity 1) undefined <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Num</span> a <span class="org-haskell-operator">=&gt;</span> <span class="org-haskell-constructor">Either</span> <span class="org-haskell-constructor">String</span> a
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse (identity 1) undefined
<span class="org-haskell-constructor">Right</span> 1
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse (identity <span class="org-string">"foo"</span>) undefined
<span class="org-haskell-constructor">Right</span> <span class="org-string">"foo"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-keyword">let</span> before <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">ParseState</span> (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"foo"</span>) 0
<span class="org-haskell-operator">&gt;&gt;&gt;</span> before
<span class="org-haskell-constructor">ParseState</span> {string <span class="org-haskell-operator">=</span> <span class="org-string">"foo"</span><span class="org-haskell-operator">,</span> offset <span class="org-haskell-operator">=</span> 0}
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-keyword">let</span> after <span class="org-haskell-operator">=</span> modifyOffset before 3
<span class="org-haskell-operator">&gt;&gt;&gt;</span> after
<span class="org-haskell-constructor">ParseState</span> {string <span class="org-haskell-operator">=</span> <span class="org-string">"foo"</span><span class="org-haskell-operator">,</span> offset <span class="org-haskell-operator">=</span> 3}
<span class="org-haskell-operator">&gt;&gt;&gt;</span>

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t <span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>uncons
<span class="org-function-name">L8.uncons</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> (<span class="org-haskell-constructor">Char</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">L.ByteString</span>)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t <span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack
<span class="org-function-name">L8.pack</span> <span class="org-haskell-operator">::</span> [<span class="org-haskell-constructor">Char</span>] <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">L.ByteString</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"foo"</span>
<span class="org-string">"foo"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t <span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"foo"</span>
<span class="org-haskell-constructor">L8</span><span class="org-haskell-definition">.</span>pack <span class="org-string">"foo"</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>uncons <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"foo"</span>
<span class="org-haskell-constructor">Just</span> (<span class="org-string">'f'</span><span class="org-haskell-operator">,</span><span class="org-string">"oo"</span>)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>uncons <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>empty
<span class="org-haskell-constructor">Nothing</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t runParse
<span class="org-function-name">runParse</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Parse</span> a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">ParseState</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Either</span> <span class="org-haskell-constructor">String</span> (a<span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">ParseState</span>)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t parse
<span class="org-function-name">parse</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Parse</span> a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">L.ByteString</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Either</span> <span class="org-haskell-constructor">String</span> a

<span class="org-comment-delimiter">-- </span><span class="org-comment">0xff = 255</span>
<span class="org-comment-delimiter">--</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse parseByte (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"\xff"</span>)
<span class="org-haskell-constructor">Right</span> 255
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse parseByte (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"\xa"</span>)
<span class="org-haskell-constructor">Right</span> 10
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse parseByte (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"\xb"</span>)
<span class="org-haskell-constructor">Right</span> 11
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse parseByte (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">""</span>)
<span class="org-haskell-constructor">Left</span> <span class="org-string">"byte offset 0: no more input"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-comment-delimiter">-- </span><span class="org-comment">0xfa = 16 * 15 + 10  = 250 decimal </span>
<span class="org-comment-delimiter">--</span>
<span class="org-comment-delimiter">--</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runParse parseByte  <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">ParseState</span> (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"\xfa"</span>) 0
<span class="org-haskell-constructor">Right</span> (250<span class="org-haskell-operator">,</span><span class="org-haskell-constructor">ParseState</span> {string <span class="org-haskell-operator">=</span> <span class="org-string">""</span><span class="org-haskell-operator">,</span> offset <span class="org-haskell-operator">=</span> 1})
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> runParse parseByte  <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">ParseState</span> (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"x9023"</span>) 1
<span class="org-haskell-constructor">Right</span> (120<span class="org-haskell-operator">,</span><span class="org-haskell-constructor">ParseState</span> {string <span class="org-haskell-operator">=</span> <span class="org-string">"9023"</span><span class="org-haskell-operator">,</span> offset <span class="org-haskell-operator">=</span> 2})
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> runParse parseByte  <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">ParseState</span> (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">""</span>) 1
<span class="org-haskell-constructor">Left</span> <span class="org-string">"byte offset 1: no more input"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-keyword">let</span> input <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"foo"</span>

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t input
<span class="org-function-name">input</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">L.ByteString</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">L</span><span class="org-haskell-operator">.</span>head input
102
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse parseByte input
<span class="org-haskell-constructor">Right</span> 102
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse (id <span class="org-haskell-operator">&lt;$&gt;</span> parseByte) input
<span class="org-haskell-constructor">Right</span> 102
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse ((<span class="org-haskell-operator">*</span>2) <span class="org-haskell-operator">&lt;$&gt;</span> parseByte) input
<span class="org-haskell-constructor">Right</span> 204 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse parseNat (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"10023 asdb"</span>)
<span class="org-haskell-constructor">Right</span> 10023
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse parseNat (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"sad10023 asdb"</span>)
<span class="org-haskell-constructor">Left</span> <span class="org-string">"byte offset 0: no more input"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse parseChar (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">"23"</span>)
<span class="org-haskell-constructor">Right</span> <span class="org-string">'2'</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> parse parseChar (<span class="org-haskell-constructor">L8</span><span class="org-haskell-operator">.</span>pack <span class="org-string">""</span>)
<span class="org-haskell-constructor">Left</span> <span class="org-string">"byte offset 0: no more input"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-6-3" class="outline-4">
<h4 id="sec-1-6-3"><span class="section-number-4">1.6.3</span> TreeMap.sh</h4>
<div class="outline-text-4" id="text-1-6-3">
<p>
Page: 244 - File: <a href="rwh/ch10/TreeMap.hs">rwh/ch10/TreeMap.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">Tree</span> a <span class="org-haskell-operator">=</span>  <span class="org-haskell-constructor">Node</span> (<span class="org-haskell-constructor">Tree</span> a) (<span class="org-haskell-constructor">Tree</span> a)
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">Leaf</span> a 
              <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Show</span>)

<span class="org-haskell-definition">treeLengths</span> (<span class="org-haskell-constructor">Leaf</span> s) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Leaf</span> (length s)
<span class="org-haskell-definition">treeLengths</span> (<span class="org-haskell-constructor">Node</span> l r) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Node</span> (treeLengths l) (treeLengths r)

<span class="org-function-name">treeMap</span> <span class="org-haskell-operator">::</span> (a <span class="org-haskell-operator">-&gt;</span> b) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Tree</span> a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Tree</span> b
<span class="org-haskell-definition">treeMap</span> f (<span class="org-haskell-constructor">Leaf</span> a)   <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Leaf</span> (f a)
<span class="org-haskell-definition">treeMap</span> f (<span class="org-haskell-constructor">Node</span> l r) <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Node</span> (treeMap f l) (treeMap f r)

<span class="org-comment-delimiter">{-</span>
<span class="org-comment">class Functor f where</span>
<span class="org-comment">    fmap :: (a -&gt; b) -&gt; f a -&gt; f b</span>
<span class="org-comment">-}</span>
<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Functor</span> <span class="org-haskell-constructor">Tree</span> <span class="org-haskell-keyword">where</span>
    fmap <span class="org-haskell-operator">=</span> treeMap

<span class="org-haskell-operator">&gt;&gt;&gt;</span> fmap length (<span class="org-haskell-constructor">Node</span> (<span class="org-haskell-constructor">Leaf</span> <span class="org-string">"North Carolina"</span>) (<span class="org-haskell-constructor">Leaf</span> <span class="org-string">"Puerto Rico"</span>))
<span class="org-haskell-constructor">Node</span> (<span class="org-haskell-constructor">Leaf</span> 14) (<span class="org-haskell-constructor">Leaf</span> 11)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> fmap id (<span class="org-haskell-constructor">Node</span> (<span class="org-haskell-constructor">Leaf</span> <span class="org-string">"a"</span>) (<span class="org-haskell-constructor">Leaf</span> <span class="org-string">"b"</span>))
<span class="org-haskell-constructor">Node</span> (<span class="org-haskell-constructor">Leaf</span> <span class="org-string">"a"</span>) (<span class="org-haskell-constructor">Leaf</span> <span class="org-string">"b"</span>)
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>


<p>
Running: 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"rwh/ch10/TreeMap.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( rwh<span class="org-haskell-operator">/</span>ch10<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">TreeMap</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>info <span class="org-haskell-constructor">Tree</span>
<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">Tree</span> a <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Node</span> (<span class="org-haskell-constructor">Tree</span> a) (<span class="org-haskell-constructor">Tree</span> a) <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">Leaf</span> a
        <span class="org-comment-delimiter">-- </span><span class="org-comment">Defined at rwh/ch10/TreeMap.hs:2:1</span>
<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Show</span> a <span class="org-haskell-operator">=&gt;</span> <span class="org-haskell-constructor">Show</span> (<span class="org-haskell-constructor">Tree</span> a)
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Defined at rwh/ch10/TreeMap.hs:4:25</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-keyword">let</span> tree <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Node</span> (<span class="org-haskell-constructor">Leaf</span> <span class="org-string">"foo"</span>) (<span class="org-haskell-constructor">Node</span> (<span class="org-haskell-constructor">Leaf</span> <span class="org-string">"x"</span>) (<span class="org-haskell-constructor">Leaf</span> <span class="org-string">"quux"</span>))
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t tree
<span class="org-function-name">tree</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Tree</span> [<span class="org-haskell-constructor">Char</span>]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> treeLengths tree
<span class="org-haskell-constructor">Node</span> (<span class="org-haskell-constructor">Leaf</span> 3) (<span class="org-haskell-constructor">Node</span> (<span class="org-haskell-constructor">Leaf</span> 1) (<span class="org-haskell-constructor">Leaf</span> 4))
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> treeMap (odd <span class="org-haskell-operator">.</span> length) tree
<span class="org-haskell-constructor">Node</span> (<span class="org-haskell-constructor">Leaf</span> <span class="org-haskell-constructor">True</span>) (<span class="org-haskell-constructor">Node</span> (<span class="org-haskell-constructor">Leaf</span> <span class="org-haskell-constructor">True</span>) (<span class="org-haskell-constructor">Leaf</span> <span class="org-haskell-constructor">False</span>))
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7"><span class="section-number-3">1.7</span> Chapter 13 - Data Structures</h3>
<div class="outline-text-3" id="text-1-7">
</div><div id="outline-container-sec-1-7-1" class="outline-4">
<h4 id="sec-1-7-1"><span class="section-number-4">1.7.1</span> passwd-al.hs</h4>
<div class="outline-text-4" id="text-1-7-1">
<p>
Page 300 - File: <a href="rwh/ch13/passwd-al.hs">rwh/ch13/passwd-al.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-comment-delimiter">-- </span><span class="org-comment">file: ch13/passwd-al.hs</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.List</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">System.IO</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Control.Monad</span>(when)
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">System.Exit</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">System.Environment</span>(getArgs)

<span class="org-haskell-definition">main</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>

    <span class="org-comment-delimiter">-- </span><span class="org-comment">Load the command-line arguments</span>
    args <span class="org-haskell-operator">&lt;-</span> getArgs

    <span class="org-comment-delimiter">-- </span><span class="org-comment">If we don't have the right amount of args, give an error and abort</span>
    when (length args <span class="org-haskell-operator">/=</span> 2) <span class="org-haskell-operator">$</span> <span class="org-haskell-keyword">do</span>
        putStrLn <span class="org-string">"Syntax: passwd-al filename uid"</span>
        exitFailure

    <span class="org-comment-delimiter">-- </span><span class="org-comment">Read the file lazily</span>
    content <span class="org-haskell-operator">&lt;-</span> readFile (args <span class="org-haskell-operator">!!</span> 0)

    <span class="org-comment-delimiter">-- </span><span class="org-comment">Compute the username in pure code</span>
    <span class="org-haskell-keyword">let</span> username <span class="org-haskell-operator">=</span> findByUID content (read (args <span class="org-haskell-operator">!!</span> 1))

    <span class="org-comment-delimiter">-- </span><span class="org-comment">Display the result</span>
    <span class="org-haskell-keyword">case</span> username <span class="org-haskell-keyword">of</span> 
         <span class="org-haskell-constructor">Just</span> x <span class="org-haskell-operator">-&gt;</span> putStrLn x
         <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">-&gt;</span> putStrLn <span class="org-string">"Could not find that UID"</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">Given the entire input and a UID, see if we can find a username.</span>
<span class="org-function-name">findByUID</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Integer</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-constructor">String</span>
<span class="org-haskell-definition">findByUID</span> content uid <span class="org-haskell-operator">=</span>
    <span class="org-haskell-keyword">let</span> al <span class="org-haskell-operator">=</span> map parseline <span class="org-haskell-operator">.</span> lines <span class="org-haskell-operator">$</span> content
        <span class="org-haskell-keyword">in</span> lookup uid al

<span class="org-comment-delimiter">-- </span><span class="org-comment">Convert a colon-separated line into fields</span>
<span class="org-function-name">parseline</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-constructor">Integer</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">String</span>)
<span class="org-haskell-definition">parseline</span> input <span class="org-haskell-operator">=</span>
    <span class="org-haskell-keyword">let</span> fields <span class="org-haskell-operator">=</span> split <span class="org-string">':'</span> input
        <span class="org-haskell-keyword">in</span> (read (fields <span class="org-haskell-operator">!!</span> 2)<span class="org-haskell-operator">,</span> fields <span class="org-haskell-operator">!!</span> 0)

<span class="org-doc">{- | Takes a delimiter and a list. Break up the list based on the</span>
<span class="org-doc">-  delimiter. -}</span>
<span class="org-function-name">split</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Eq</span> a <span class="org-haskell-operator">=&gt;</span> a <span class="org-haskell-operator">-&gt;</span> [a] <span class="org-haskell-operator">-&gt;</span> [[a]]

<span class="org-comment-delimiter">-- </span><span class="org-comment">If the input is empty, the result is a list of empty lists.</span>
<span class="org-haskell-definition">split</span> <span class="org-haskell-keyword">_</span> <span class="org-haskell-constructor">[]</span> <span class="org-haskell-operator">=</span> [<span class="org-haskell-constructor">[]</span>]
<span class="org-haskell-definition">split</span> delim str <span class="org-haskell-operator">=</span>
    <span class="org-haskell-keyword">let</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">Find the part of the list before delim and put it in "before".</span>
        <span class="org-comment-delimiter">-- </span><span class="org-comment">The rest of the list, including the leading delim, goes</span>
        <span class="org-comment-delimiter">-- </span><span class="org-comment">in "remainder".</span>
        (before<span class="org-haskell-operator">,</span> remainder) <span class="org-haskell-operator">=</span> span (<span class="org-haskell-operator">/=</span> delim) str
        <span class="org-haskell-keyword">in</span>
        before <span class="org-haskell-constructor">:</span> <span class="org-haskell-keyword">case</span> remainder <span class="org-haskell-keyword">of</span>
                      <span class="org-haskell-constructor">[]</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">[]</span>
                      x <span class="org-haskell-operator">-&gt;</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">If there is more data to process,</span>
                           <span class="org-comment-delimiter">-- </span><span class="org-comment">call split recursively to process it</span>
                           split delim (tail x)
</pre>
</div>

<p>
File: <a href="file:///rwh/ch13/passwd.txt">file:///rwh/ch13/passwd.txt</a> 
</p>

<div class="org-src-container">

<pre class="src src-txt">root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/bin/sh
man:x:6:12:man:/var/cache/man:/bin/sh
lp:x:7:7:lp:/var/spool/lpd:/bin/sh
mail:x:8:8:mail:/var/mail:/bin/sh
news:x:9:9:news:/var/spool/news:/bin/sh
jgoerzen:x:1000:1000:John Goerzen,,,:/home/jgoerzen:/bin/bash
</pre>
</div>


<p>
Running:
</p>

<pre class="example">
$ runhaskell ch13/passwd-al.hs
Syntax: passwd-al filename uid

$ runhaskell ch13/passwd-al.hs  /etc/passwd 0
root

$ runhaskell ch13/passwd-al.hs  /etc/passwd 1000
archmaster

$ runhaskell ch13/passwd-al.hs  /etc/passwd 81
dbus

$ runhaskell ch13/passwd-al.hs  ch13/passwd.txt 0
passwd-al.hs: Prelude.!!: index too large

$ runhaskell ch13/passwd-al.hs  ch13/passwd.txt 12
passwd-al.hs: Prelude.!!: index too large
</pre>
</div>
</div>

<div id="outline-container-sec-1-7-2" class="outline-4">
<h4 id="sec-1-7-2"><span class="section-number-4">1.7.2</span> buildmap.hs</h4>
<div class="outline-text-4" id="text-1-7-2">
<p>
Page 302 - File: <a href="rwh/ch13/buildmap.hs">rwh/ch13/buildmap.hs</a> 
</p>


<div class="org-src-container">

<pre class="src src-haskell"><span class="org-comment-delimiter">-- </span><span class="org-comment">file: ch13/buildmap.hs</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-keyword">qualified</span> <span class="org-haskell-constructor">Data.Map</span> <span class="org-haskell-keyword">as</span> <span class="org-haskell-constructor">Map</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">Functions to generate a Map that represents an association list</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">as a map</span>

<span class="org-haskell-definition">al</span> <span class="org-haskell-operator">=</span> [(1<span class="org-haskell-operator">,</span> <span class="org-string">"one"</span>)<span class="org-haskell-operator">,</span> (2<span class="org-haskell-operator">,</span> <span class="org-string">"two"</span>)<span class="org-haskell-operator">,</span> (3<span class="org-haskell-operator">,</span> <span class="org-string">"three"</span>)<span class="org-haskell-operator">,</span> (4<span class="org-haskell-operator">,</span> <span class="org-string">"four"</span>)]

<span class="org-doc">{- | Create a map representation of 'al' by converting the association</span>
<span class="org-doc">-  list using Map.fromList -}</span>
<span class="org-haskell-definition">mapFromAL</span> <span class="org-haskell-operator">=</span>
    <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>fromList al

<span class="org-doc">{- | Create a map representation of 'al' by doing a fold -}</span>
<span class="org-haskell-definition">mapFold</span> <span class="org-haskell-operator">=</span>
    foldl (<span class="org-haskell-operator">\</span>map (k<span class="org-haskell-operator">,</span> v) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>insert k v map) <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>empty al

<span class="org-doc">{- | Manually create a map with the elements of 'al' in it -}</span>
<span class="org-haskell-definition">mapManual</span> <span class="org-haskell-operator">=</span>
    <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>insert 2 <span class="org-string">"two"</span> <span class="org-haskell-operator">.</span> 
    <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>insert 4 <span class="org-string">"four"</span> <span class="org-haskell-operator">.</span>
    <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>insert 1 <span class="org-string">"one"</span> <span class="org-haskell-operator">.</span>
    <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>insert 3 <span class="org-string">"three"</span> <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>empty
</pre>
</div>


<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">$</span> ghci
<span class="org-haskell-constructor">GHCi</span><span class="org-haskell-operator">,</span> version 7.10<span class="org-haskell-operator">.</span>2<span class="org-haskell-constructor">:</span> http<span class="org-haskell-constructor">://</span>www<span class="org-haskell-operator">.</span>haskell<span class="org-haskell-operator">.</span>org<span class="org-haskell-operator">/</span>ghc<span class="org-haskell-operator">/</span>  <span class="org-haskell-constructor">:?</span> for help
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load ch13<span class="org-haskell-operator">/</span>buildmap<span class="org-haskell-operator">.</span>hs 
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( ch13<span class="org-haskell-operator">/</span>buildmap<span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> al
[(1<span class="org-haskell-operator">,</span><span class="org-string">"one"</span>)<span class="org-haskell-operator">,</span>(2<span class="org-haskell-operator">,</span><span class="org-string">"two"</span>)<span class="org-haskell-operator">,</span>(3<span class="org-haskell-operator">,</span><span class="org-string">"three"</span>)<span class="org-haskell-operator">,</span>(4<span class="org-haskell-operator">,</span><span class="org-string">"four"</span>)]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> mapFromAL
<span class="org-haskell-definition">fromList</span> [(1<span class="org-haskell-operator">,</span><span class="org-string">"one"</span>)<span class="org-haskell-operator">,</span>(2<span class="org-haskell-operator">,</span><span class="org-string">"two"</span>)<span class="org-haskell-operator">,</span>(3<span class="org-haskell-operator">,</span><span class="org-string">"three"</span>)<span class="org-haskell-operator">,</span>(4<span class="org-haskell-operator">,</span><span class="org-string">"four"</span>)]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> mapFold
<span class="org-haskell-definition">fromList</span> [(1<span class="org-haskell-operator">,</span><span class="org-string">"one"</span>)<span class="org-haskell-operator">,</span>(2<span class="org-haskell-operator">,</span><span class="org-string">"two"</span>)<span class="org-haskell-operator">,</span>(3<span class="org-haskell-operator">,</span><span class="org-string">"three"</span>)<span class="org-haskell-operator">,</span>(4<span class="org-haskell-operator">,</span><span class="org-string">"four"</span>)]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> mapManual
<span class="org-haskell-definition">fromList</span> [(1<span class="org-haskell-operator">,</span><span class="org-string">"one"</span>)<span class="org-haskell-operator">,</span>(2<span class="org-haskell-operator">,</span><span class="org-string">"two"</span>)<span class="org-haskell-operator">,</span>(3<span class="org-haskell-operator">,</span><span class="org-string">"three"</span>)<span class="org-haskell-operator">,</span>(4<span class="org-haskell-operator">,</span><span class="org-string">"four"</span>)]
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-7-3" class="outline-4">
<h4 id="sec-1-7-3"><span class="section-number-4">1.7.3</span> funcrecs.hs</h4>
<div class="outline-text-4" id="text-1-7-3">
<p>
Function as data. 
</p>

<p>
Page 303 - File: <a href="rwh/ch13/funcrecs.hs">rwh/ch13/funcrecs.hs</a> 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-doc">{- | Our usual CustomColor type to play with -}</span>
<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">CustomColor</span> <span class="org-haskell-operator">=</span>
  <span class="org-haskell-constructor">CustomColor</span> {red <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span><span class="org-haskell-operator">,</span>
               green <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span><span class="org-haskell-operator">,</span>
               blue <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span>}
  <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Eq</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Show</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Read</span>)

<span class="org-doc">{- | A new type that stores a name and a function.</span>
<span class="org-doc">The function takes an Int, applies some computation to it, and returns</span>
<span class="org-doc">an Int along with a CustomColor -}</span>
<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">FuncRec</span> <span class="org-haskell-operator">=</span>
    <span class="org-haskell-constructor">FuncRec</span> {name <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span>
             colorCalc <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-constructor">CustomColor</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Int</span>)}


<span class="org-haskell-definition">plus5func</span> color x <span class="org-haskell-operator">=</span> (color<span class="org-haskell-operator">,</span> x <span class="org-haskell-operator">+</span> 5)
<span class="org-haskell-definition">purple</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">CustomColor</span> 255 0 255
<span class="org-haskell-definition">plus5</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">FuncRec</span> {name <span class="org-haskell-operator">=</span> <span class="org-string">"plus5"</span><span class="org-haskell-operator">,</span> colorCalc <span class="org-haskell-operator">=</span> plus5func purple}
<span class="org-haskell-definition">always0</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">FuncRec</span> {name <span class="org-haskell-operator">=</span> <span class="org-string">"always0"</span><span class="org-haskell-operator">,</span> colorCalc <span class="org-haskell-operator">=</span> <span class="org-haskell-operator">\</span><span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> (purple<span class="org-haskell-operator">,</span> 0)}
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load ch13<span class="org-haskell-operator">/</span>funcrecs<span class="org-haskell-operator">.</span>hs 
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( ch13<span class="org-haskell-operator">/</span>funcrecs<span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>info <span class="org-haskell-constructor">CustomColor</span>
<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">CustomColor</span>
  <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">CustomColor</span> {red <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span><span class="org-haskell-operator">,</span> green <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span><span class="org-haskell-operator">,</span> blue <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span>}
        <span class="org-comment-delimiter">-- </span><span class="org-comment">Defined at ch13/funcrecs.hs:3:1</span>
<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Eq</span> <span class="org-haskell-constructor">CustomColor</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">Defined at ch13/funcrecs.hs:7:13</span>
<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Read</span> <span class="org-haskell-constructor">CustomColor</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">Defined at ch13/funcrecs.hs:7:23</span>
<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Show</span> <span class="org-haskell-constructor">CustomColor</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">Defined at ch13/funcrecs.hs:7:17</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>info <span class="org-haskell-constructor">FuncRec</span>
<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">FuncRec</span>
  <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">FuncRec</span> {name <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span> colorCalc <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-constructor">CustomColor</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Int</span>)}
        <span class="org-comment-delimiter">-- </span><span class="org-comment">Defined at ch13/funcrecs.hs:12:1</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t plus5
<span class="org-function-name">plus5</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">FuncRec</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> name plus5
<span class="org-string">"plus5"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t colorCalc plus5
<span class="org-haskell-definition">colorCalc</span> plus5 <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-constructor">CustomColor</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Int</span>)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> (colorCalc plus5) 7
(<span class="org-haskell-constructor">CustomColor</span> {red <span class="org-haskell-operator">=</span> 255<span class="org-haskell-operator">,</span> green <span class="org-haskell-operator">=</span> 0<span class="org-haskell-operator">,</span> blue <span class="org-haskell-operator">=</span> 255}<span class="org-haskell-operator">,</span>12)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t colorCalc always0
<span class="org-haskell-definition">colorCalc</span> always0 <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-constructor">CustomColor</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Int</span>)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> (colorCalc always0) 7
(<span class="org-haskell-constructor">CustomColor</span> {red <span class="org-haskell-operator">=</span> 255<span class="org-haskell-operator">,</span> green <span class="org-haskell-operator">=</span> 0<span class="org-haskell-operator">,</span> blue <span class="org-haskell-operator">=</span> 255}<span class="org-haskell-operator">,</span>0)
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-7-4" class="outline-4">
<h4 id="sec-1-7-4"><span class="section-number-4">1.7.4</span> funcrecs2.hs</h4>
<div class="outline-text-4" id="text-1-7-4">
<p>
Page 304 - File: <a href="rwh/ch13/funcrecs2.hs">rwh/ch13/funcrecs2.hs</a> 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-comment-delimiter">-- </span><span class="org-comment">file: ch13/funcrecs2.hs</span>
<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">FuncRec</span> <span class="org-haskell-operator">=</span>
    <span class="org-haskell-constructor">FuncRec</span> {name <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span>
             calc <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int</span><span class="org-haskell-operator">,</span>
             namedCalc <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Int</span>)}

<span class="org-function-name">mkFuncRec</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int</span>) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">FuncRec</span>
<span class="org-haskell-definition">mkFuncRec</span> name calcfunc <span class="org-haskell-operator">=</span>
    <span class="org-haskell-constructor">FuncRec</span> {name <span class="org-haskell-operator">=</span> name<span class="org-haskell-operator">,</span>
             calc <span class="org-haskell-operator">=</span> calcfunc<span class="org-haskell-operator">,</span>
             namedCalc <span class="org-haskell-operator">=</span> <span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> (name<span class="org-haskell-operator">,</span> calcfunc x)}

<span class="org-haskell-definition">plus5</span> <span class="org-haskell-operator">=</span> mkFuncRec <span class="org-string">"plus5"</span> (<span class="org-haskell-operator">+</span> 5)
<span class="org-haskell-definition">always0</span> <span class="org-haskell-operator">=</span> mkFuncRec <span class="org-string">"always0"</span> (<span class="org-haskell-operator">\</span><span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> 0)
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load ch13<span class="org-haskell-operator">/</span>funcrecs2<span class="org-haskell-operator">.</span>hs 
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( ch13<span class="org-haskell-operator">/</span>funcrecs2<span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t plus5
<span class="org-function-name">plus5</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">FuncRec</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> name plus5
<span class="org-string">"plus5"</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t name
<span class="org-function-name">name</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">FuncRec</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t namedCalc
<span class="org-function-name">namedCalc</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">FuncRec</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Int</span>)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t calc
<span class="org-function-name">calc</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">FuncRec</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> (calc plus5) 5
10
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-keyword">let</span> plus5a <span class="org-haskell-operator">=</span> plus5 {name <span class="org-haskell-operator">=</span> <span class="org-string">"PLUS5A"</span>}
 <span class="org-haskell-operator">*</span><span class="org-haskell-constructor">Main</span> <span class="org-haskell-constructor">System.Directory</span> <span class="org-haskell-constructor">System.Process</span><span class="org-haskell-operator">|</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t plus5a
<span class="org-function-name">plus5a</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">FuncRec</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> (namedCalc plus5a) 5
(<span class="org-string">"plus5"</span><span class="org-haskell-operator">,</span>10)
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-7-5" class="outline-4">
<h4 id="sec-1-7-5"><span class="section-number-4">1.7.5</span> passwdmap.hs</h4>
<div class="outline-text-4" id="text-1-7-5">
<p>
Page: 305 - File: <a href="rwh/ch13/passwdmap.hs">rwh/ch13/passwdmap.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-comment-delimiter">-- </span><span class="org-comment">file: ch13/passwdmap.hs</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.List</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-keyword">qualified</span> <span class="org-haskell-constructor">Data.Map</span> <span class="org-haskell-keyword">as</span> <span class="org-haskell-constructor">Map</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">System.IO</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Text.Printf</span>(printf)
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">System.Environment</span>(getArgs)
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">System.Exit</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Control.Monad</span>(when)


<span class="org-doc">{- | The primary piece of data this program will store.</span>
<span class="org-doc">   It represents the fields in a POSIX /etc/passwd file -}</span>
<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">PasswdEntry</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">PasswdEntry</span> {
    userName <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span>
    password <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span>
    uid <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Integer</span><span class="org-haskell-operator">,</span>
    gid <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Integer</span><span class="org-haskell-operator">,</span>
    gecos <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span>
    homeDir <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span>
    shell <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span>}
    <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Eq</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Ord</span>)

<span class="org-doc">{- | Define how we get data to a 'PasswdEntry'. -}</span>
<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Show</span> <span class="org-haskell-constructor">PasswdEntry</span> <span class="org-haskell-keyword">where</span>
    show pe <span class="org-haskell-operator">=</span> printf <span class="org-string">"%s:%s:%d:%d:%s:%s:%s"</span> 
                (userName pe) (password pe) (uid pe) (gid pe)
                (gecos pe) (homeDir pe) (shell pe)

<span class="org-doc">{- | Converting data back out of a 'PasswdEntry'. -}</span>
<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Read</span> <span class="org-haskell-constructor">PasswdEntry</span> <span class="org-haskell-keyword">where</span>
    readsPrec <span class="org-haskell-keyword">_</span> value <span class="org-haskell-operator">=</span>
        <span class="org-haskell-keyword">case</span> split <span class="org-string">':'</span> value <span class="org-haskell-keyword">of</span>
             [f1<span class="org-haskell-operator">,</span> f2<span class="org-haskell-operator">,</span> f3<span class="org-haskell-operator">,</span> f4<span class="org-haskell-operator">,</span> f5<span class="org-haskell-operator">,</span> f6<span class="org-haskell-operator">,</span> f7] <span class="org-haskell-operator">-&gt;</span>
                 <span class="org-comment-delimiter">-- </span><span class="org-comment">Generate a 'PasswdEntry' the shorthand way:</span>
                 <span class="org-comment-delimiter">-- </span><span class="org-comment">using the positional fields.  We use 'read' to convert</span>
                 <span class="org-comment-delimiter">-- </span><span class="org-comment">the numeric fields to Integers.</span>
                 [(<span class="org-haskell-constructor">PasswdEntry</span> f1 f2 (read f3) (read f4) f5 f6 f7<span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">[]</span>)]
             x <span class="org-haskell-operator">-&gt;</span> error <span class="org-haskell-operator">$</span> <span class="org-string">"Invalid number of fields in input: "</span> <span class="org-haskell-operator">++</span> show x
        <span class="org-haskell-keyword">where</span> 
        <span class="org-doc">{- | Takes a delimiter and a list.  Break up the list based on the</span>
<span class="org-doc">        -  delimiter. -}</span>
        split <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Eq</span> a <span class="org-haskell-operator">=&gt;</span> a <span class="org-haskell-operator">-&gt;</span> [a] <span class="org-haskell-operator">-&gt;</span> [[a]]
        <span class="org-comment-delimiter">-- </span><span class="org-comment">If the input is empty, the result is a list of empty lists.</span>
        split <span class="org-haskell-keyword">_</span> <span class="org-haskell-constructor">[]</span> <span class="org-haskell-operator">=</span> [<span class="org-haskell-constructor">[]</span>]
        split delim str <span class="org-haskell-operator">=</span>
            <span class="org-haskell-keyword">let</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">Find the part of the list before delim and put it in</span>
                <span class="org-comment-delimiter">-- </span><span class="org-comment">"before".  The rest of the list, including the leading </span>
                <span class="org-comment-delimiter">-- </span><span class="org-comment">delim, goes in "remainder".</span>
                (before<span class="org-haskell-operator">,</span> remainder) <span class="org-haskell-operator">=</span> span (<span class="org-haskell-operator">/=</span> delim) str
                <span class="org-haskell-keyword">in</span>
                before <span class="org-haskell-constructor">:</span> <span class="org-haskell-keyword">case</span> remainder <span class="org-haskell-keyword">of</span>
                              <span class="org-haskell-constructor">[]</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">[]</span>
                              x <span class="org-haskell-operator">-&gt;</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">If there is more data to process,</span>
                                   <span class="org-comment-delimiter">-- </span><span class="org-comment">call split recursively to process it</span>
                                   split delim (tail x)


<span class="org-comment-delimiter">-- </span><span class="org-comment">Convenience aliases; we'll have two maps: one from UID to entries</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">and the other from username to entries</span>
<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">UIDMap</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Map.Map</span> <span class="org-haskell-constructor">Integer</span> <span class="org-haskell-constructor">PasswdEntry</span>
<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">UserMap</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Map.Map</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-constructor">PasswdEntry</span>

<span class="org-doc">{- | Converts input data to maps.  Returns UID and User maps. -}</span>
<span class="org-function-name">inputToMaps</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-constructor">UIDMap</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">UserMap</span>)
<span class="org-haskell-definition">inputToMaps</span> inp <span class="org-haskell-operator">=</span>
    (uidmap<span class="org-haskell-operator">,</span> usermap)
    <span class="org-haskell-keyword">where</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">fromList converts a [(key, value)] list into a Map</span>
    uidmap <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>fromList <span class="org-haskell-operator">.</span> map (<span class="org-haskell-operator">\</span>pe <span class="org-haskell-operator">-&gt;</span> (uid pe<span class="org-haskell-operator">,</span> pe)) <span class="org-haskell-operator">$</span> entries
    usermap <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>fromList <span class="org-haskell-operator">.</span> 
              map (<span class="org-haskell-operator">\</span>pe <span class="org-haskell-operator">-&gt;</span> (userName pe<span class="org-haskell-operator">,</span> pe)) <span class="org-haskell-operator">$</span> entries
    <span class="org-comment-delimiter">-- </span><span class="org-comment">Convert the input String to [PasswdEntry]</span>
    entries <span class="org-haskell-operator">=</span> map read (lines inp)


<span class="org-haskell-definition">main</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">Load the command-line arguments</span>
    args <span class="org-haskell-operator">&lt;-</span> getArgs
    <span class="org-comment-delimiter">-- </span><span class="org-comment">If we don't have the right number of args,</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">give an error and abort</span>
    when (length args <span class="org-haskell-operator">/=</span> 1) <span class="org-haskell-operator">$</span> <span class="org-haskell-keyword">do</span>
        putStrLn <span class="org-string">"Syntax: passwdmap filename"</span>
        exitFailure
    <span class="org-comment-delimiter">-- </span><span class="org-comment">Read the file lazily</span>
    content <span class="org-haskell-operator">&lt;-</span> readFile (head args)
    <span class="org-haskell-keyword">let</span> maps <span class="org-haskell-operator">=</span> inputToMaps content
    mainMenu maps

<span class="org-haskell-definition">mainMenu</span> maps<span class="org-haskell-operator">@</span>(uidmap<span class="org-haskell-operator">,</span> usermap) <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
    putStr optionText
    hFlush stdout
    sel <span class="org-haskell-operator">&lt;-</span> getLine
    <span class="org-comment-delimiter">-- </span><span class="org-comment">See what they want to do.  For every option except 4,</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">return them to the main menu afterwards by calling</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">mainMenu recursively</span>
    <span class="org-haskell-keyword">case</span> sel <span class="org-haskell-keyword">of</span>
         <span class="org-string">"1"</span> <span class="org-haskell-operator">-&gt;</span> lookupUserName <span class="org-haskell-operator">&gt;&gt;</span> mainMenu maps
         <span class="org-string">"2"</span> <span class="org-haskell-operator">-&gt;</span> lookupUID <span class="org-haskell-operator">&gt;&gt;</span> mainMenu maps
         <span class="org-string">"3"</span> <span class="org-haskell-operator">-&gt;</span> displayFile <span class="org-haskell-operator">&gt;&gt;</span> mainMenu maps
         <span class="org-string">"4"</span> <span class="org-haskell-operator">-&gt;</span> return <span class="org-haskell-constructor">()</span>
         <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> putStrLn <span class="org-string">"Invalid selection"</span> <span class="org-haskell-operator">&gt;&gt;</span> mainMenu maps
    <span class="org-haskell-keyword">where</span> 
    lookupUserName <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
        putStrLn <span class="org-string">"Username: "</span>
        username <span class="org-haskell-operator">&lt;-</span> getLine
        <span class="org-haskell-keyword">case</span> <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>lookup username usermap <span class="org-haskell-keyword">of</span>
             <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">-&gt;</span> putStrLn <span class="org-string">"Not found."</span>
             <span class="org-haskell-constructor">Just</span> x <span class="org-haskell-operator">-&gt;</span> print x
   
    lookupUID <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
        putStrLn <span class="org-string">"UID: "</span>
        uidstring <span class="org-haskell-operator">&lt;-</span> getLine
        <span class="org-haskell-keyword">case</span> <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>lookup (read uidstring) uidmap <span class="org-haskell-keyword">of</span>
             <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">-&gt;</span> putStrLn <span class="org-string">"Not found."</span>
             <span class="org-haskell-constructor">Just</span> x <span class="org-haskell-operator">-&gt;</span> print x

    displayFile <span class="org-haskell-operator">=</span> 
        putStr <span class="org-haskell-operator">.</span> unlines <span class="org-haskell-operator">.</span> map (show <span class="org-haskell-operator">.</span> snd) <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">Map</span><span class="org-haskell-operator">.</span>toList <span class="org-haskell-operator">$</span> uidmap

    optionText <span class="org-haskell-operator">=</span> 
          <span class="org-string">"\npasswdmap options:\n\</span>
<span class="org-string">           \\n\</span>
<span class="org-string">           \1   Look up a user name\n\</span>
<span class="org-string">           \2   Look up a UID\n\</span>
<span class="org-string">           \3   Display entire file\n\</span>
<span class="org-string">           \4   Quit\n\n\</span>
<span class="org-string">           \Your selection: "</span>
</pre>
</div>

<p>
Running:
</p>

<pre class="example">
$ runhaskell ch13/passwdmap.hs 
Syntax: passwdmap filename

$ runhaskell ch13/passwdmap.hs /etc/passwd

passwdmap options:

1   Look up a user name
2   Look up a UID
3   Display entire file
4   Quit

Your selection: 1
Username: 
archmaster
archmaster:x:1000:1000::/home/archmaster:/bin/bash

passwdmap options:

1   Look up a user name
2   Look up a UID
3   Display entire file
4   Quit

Your selection: 2
UID: 
1000
archmaster:x:1000:1000::/home/archmaster:/bin/bash

passwdmap options:

1   Look up a user name
2   Look up a UID
3   Display entire file
4   Quit

Your selection: 3
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/usr/bin/nologin
daemon:x:2:2:daemon:/:/usr/bin/nologin
mail:x:8:12:mail:/var/spool/mail:/usr/bin/nologin
ftp:x:14:11:ftp:/srv/ftp:/usr/bin/nologin
http:x:33:33:http:/srv/http:/usr/bin/nologin
uuidd:x:68:68:uuidd:/:/usr/bin/nologin
dbus:x:81:81:dbus:/:/usr/bin/nologin
avahi:x:84:84:avahi:/:/bin/nologin
ntp:x:87:87:Network Time Protocol:/var/lib/ntp:/bin/false
nobody:x:99:99:nobody:/:/usr/bin/nologin
polkitd:x:102:102:Policy Kit Daemon:/:/usr/bin/nologin
colord:x:124:124::/var/lib/colord:/bin/false
systemd-journal-gateway:x:191:191:systemd-journal-gateway:/:/usr/bin/nologin
systemd-timesync:x:192:192:systemd-timesync:/:/usr/bin/nologin
systemd-network:x:193:193:systemd-network:/:/usr/bin/nologin
systemd-bus-proxy:x:194:194:systemd-bus-proxy:/:/usr/bin/nologin
systemd-resolve:x:195:195:systemd-resolve:/:/usr/bin/nologin
git:x:996:996:git daemon user:/:/bin/bash
systemd-journal-upload:x:997:997:systemd Journal Upload:/:/sbin/nologin
systemd-coredump:x:998:998:systemd Core Dumper:/:/sbin/nologin
systemd-journal-remote:x:999:999:systemd Journal Remote:/:/sbin/nologin
archmaster:x:1000:1000::/home/archmaster:/bin/bash

passwdmap options:

1   Look up a user name
2   Look up a UID
3   Display entire file
4   Quit

Your selection: 4
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8"><span class="section-number-3">1.8</span> Chapter 14 - Monads</h3>
<div class="outline-text-3" id="text-1-8">
</div><div id="outline-container-sec-1-8-1" class="outline-4">
<h4 id="sec-1-8-1"><span class="section-number-4">1.8.1</span> Maybe.hs</h4>
<div class="outline-text-4" id="text-1-8-1">
<p>
Page 367 - File: <a href="rwh/ch14/Maybe.hs">rwh/ch14/Maybe.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-comment-delimiter">-- </span><span class="org-comment">file: ch14/Maybe.hs </span>

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">Maybe</span> a <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span> <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">Just</span> a 

<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Monad</span> <span class="org-haskell-constructor">Maybe</span> <span class="org-haskell-keyword">where</span>
  
 <span class="org-comment-delimiter">-- </span><span class="org-comment">chain </span>
 (<span class="org-haskell-operator">&gt;&gt;=</span>) <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Maybe</span> a <span class="org-haskell-operator">-&gt;</span> (a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> b) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> b
 <span class="org-haskell-constructor">Just</span> x    <span class="org-haskell-operator">&gt;&gt;=</span> fn <span class="org-haskell-operator">=</span> fn x
 <span class="org-haskell-constructor">Nothing</span>   <span class="org-haskell-operator">&gt;&gt;=</span> fn <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span>

 <span class="org-comment-delimiter">-- </span><span class="org-comment">inject </span>
 return <span class="org-haskell-operator">::</span> a <span class="org-haskell-operator">-&gt;</span>  <span class="org-haskell-constructor">Maybe</span> a
 return a <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Just</span> a 

 <span class="org-comment-delimiter">--</span><span class="org-comment">-</span>
 (<span class="org-haskell-operator">&gt;&gt;</span>) <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Maybe</span> a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> b <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> b
 <span class="org-haskell-constructor">Just</span> <span class="org-haskell-keyword">_</span>   <span class="org-haskell-operator">&gt;&gt;</span> mb <span class="org-haskell-operator">=</span> mb
 <span class="org-haskell-constructor">Nothing</span>  <span class="org-haskell-operator">&gt;&gt;</span> mb <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span>
 
 fail <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Nothing</span> 



<span class="org-comment-delimiter">{- </span><span class="org-comment">Function that executes the Maybe monad. If the computation </span>
<span class="org-comment">   fails the third parameter is Nothing it returns the value n, </span>
<span class="org-comment">   on  the other hand if the computation succeeds the third</span>
<span class="org-comment">   parameter is (Just x) it applies the function (a -&gt; b) to the</span>
<span class="org-comment">   value x wrapped in the monad. </span>

<span class="org-comment">-}</span>
<span class="org-function-name">maybe</span> <span class="org-haskell-operator">::</span> b <span class="org-haskell-operator">-&gt;</span> (a <span class="org-haskell-operator">-&gt;</span> b ) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Maybe</span> a <span class="org-haskell-operator">-&gt;</span> b
<span class="org-haskell-definition">maybe</span> n <span class="org-haskell-keyword">_</span> <span class="org-haskell-constructor">Nothing</span>  <span class="org-haskell-operator">=</span> n 
<span class="org-haskell-definition">maybe</span> <span class="org-haskell-keyword">_</span> f (<span class="org-haskell-constructor">Just</span> x) <span class="org-haskell-operator">=</span> f x
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-8-2" class="outline-4">
<h4 id="sec-1-8-2"><span class="section-number-4">1.8.2</span> MultiplyTo.hs</h4>
<div class="outline-text-4" id="text-1-8-2">
<p>
Page: 343. File: <a href="rwh/ch14/MultiplyTo.hs">rwh/ch14/MultiplyTo.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-function-name">guarded</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Bool</span> <span class="org-haskell-operator">-&gt;</span> [a] <span class="org-haskell-operator">-&gt;</span> [a]
<span class="org-haskell-definition">guarded</span> <span class="org-haskell-constructor">True</span>  xs <span class="org-haskell-operator">=</span> xs
<span class="org-haskell-definition">guarded</span> <span class="org-haskell-constructor">False</span> <span class="org-haskell-keyword">_</span>  <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">[]</span>

<span class="org-function-name">multiplyTo</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> [(<span class="org-haskell-constructor">Int</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Int</span>)]
<span class="org-haskell-definition">multiplyTo</span> n <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span> 
  x <span class="org-haskell-operator">&lt;-</span> [1<span class="org-haskell-operator">..</span>n]
  y <span class="org-haskell-operator">&lt;-</span> [x<span class="org-haskell-operator">..</span>n]
  guarded (x <span class="org-haskell-operator">*</span> y <span class="org-haskell-operator">==</span> n) <span class="org-haskell-operator">$</span>
    return (x<span class="org-haskell-operator">,</span> y)
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load ch14<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">MultiplyTo</span><span class="org-haskell-operator">.</span>hs 
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( ch14<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">MultiplyTo</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t multiplyTo 
<span class="org-function-name">multiplyTo</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> [(<span class="org-haskell-constructor">Int</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Int</span>)]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> multiplyTo 8
[(1<span class="org-haskell-operator">,</span>8)<span class="org-haskell-operator">,</span>(2<span class="org-haskell-operator">,</span>4)]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> multiplyTo 100
[(1<span class="org-haskell-operator">,</span>100)<span class="org-haskell-operator">,</span>(2<span class="org-haskell-operator">,</span>50)<span class="org-haskell-operator">,</span>(4<span class="org-haskell-operator">,</span>25)<span class="org-haskell-operator">,</span>(5<span class="org-haskell-operator">,</span>20)<span class="org-haskell-operator">,</span>(10<span class="org-haskell-operator">,</span>10)]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> multiplyTo 891
[(1<span class="org-haskell-operator">,</span>891)<span class="org-haskell-operator">,</span>(3<span class="org-haskell-operator">,</span>297)<span class="org-haskell-operator">,</span>(9<span class="org-haskell-operator">,</span>99)<span class="org-haskell-operator">,</span>(11<span class="org-haskell-operator">,</span>81)<span class="org-haskell-operator">,</span>(27<span class="org-haskell-operator">,</span>33)]
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> multiplyTo 1000
[(1<span class="org-haskell-operator">,</span>1000)<span class="org-haskell-operator">,</span>(2<span class="org-haskell-operator">,</span>500)<span class="org-haskell-operator">,</span>(4<span class="org-haskell-operator">,</span>250)<span class="org-haskell-operator">,</span>(5<span class="org-haskell-operator">,</span>200)<span class="org-haskell-operator">,</span>(8<span class="org-haskell-operator">,</span>125)<span class="org-haskell-operator">,</span>(10<span class="org-haskell-operator">,</span>100)<span class="org-haskell-operator">,</span>(20<span class="org-haskell-operator">,</span>50)<span class="org-haskell-operator">,</span>(25<span class="org-haskell-operator">,</span>40)]
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-8-3" class="outline-4">
<h4 id="sec-1-8-3"><span class="section-number-4">1.8.3</span> SimpleState.hs</h4>
<div class="outline-text-4" id="text-1-8-3">
<p>
Page: 347 - File: <a href="rwh/ch14/SimpleState.hs">rwh/ch14/SimpleState.hs</a> 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-comment-delimiter">-- </span><span class="org-comment">file: ch14/SimpleState.hs</span>

<span class="org-comment-delimiter">{-</span>
<span class="org-comment">   This function transforms one state into another yielding</span>
<span class="org-comment">   a result (output). The state monad is also called</span>
<span class="org-comment">   State Transformer Monad. </span>

<span class="org-comment">   s            : Type of state</span>
<span class="org-comment">   a            : Type of state output</span>

<span class="org-comment">   s -&gt; (a, s)  : State transformer function </span>


<span class="org-comment">            :: SimpleState s a         :: SimpleState s a</span>

<span class="org-comment">             |-------------|            |-------------|</span>
<span class="org-comment">State 0      |             | State 1    |             | State 2</span>
<span class="org-comment">        ---&gt; | a -&gt; (a, s) | ------&gt;    | a -&gt; (a, s) | -------&gt;            </span>
<span class="org-comment">             |-------------|            |-------------|  </span>
<span class="org-comment">                  |                                |</span>
<span class="org-comment">                  |                                |</span>
<span class="org-comment">                 \ / Output 1: a                  \ /  Output 2: a</span>

<span class="org-comment"> -}</span>
<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">SimpleState</span> s a <span class="org-haskell-operator">=</span> s <span class="org-haskell-operator">-&gt;</span> (a<span class="org-haskell-operator">,</span> s)

<span class="org-comment-delimiter">-- </span><span class="org-comment">A type can be partially applied. The type constructor is:</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">SimpleState s</span>
<span class="org-comment-delimiter">-- </span>
<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">StringState</span> a <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">SimpleState</span> <span class="org-haskell-constructor">String</span> a

<span class="org-function-name">returnSt</span> <span class="org-haskell-operator">::</span> a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">SimpleState</span> s a
<span class="org-haskell-definition">returnSt</span> a <span class="org-haskell-operator">=</span> <span class="org-haskell-operator">\</span>s <span class="org-haskell-operator">-&gt;</span> (a<span class="org-haskell-operator">,</span> s)

<span class="org-function-name">returnAlt</span> <span class="org-haskell-operator">::</span> a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">SimpleState</span> s a
<span class="org-haskell-definition">returnAlt</span> a s <span class="org-haskell-operator">=</span> (a<span class="org-haskell-operator">,</span> s)

<span class="org-function-name">bindSt</span> <span class="org-haskell-operator">::</span> (<span class="org-haskell-constructor">SimpleState</span> s a) <span class="org-haskell-operator">-&gt;</span> (a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">SimpleState</span> s b) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">SimpleState</span> s b
<span class="org-haskell-definition">bindSt</span> m fn <span class="org-haskell-operator">=</span> <span class="org-haskell-operator">\</span>s <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-keyword">let</span> (a<span class="org-haskell-operator">,</span> s') <span class="org-haskell-operator">=</span> m s
                    <span class="org-haskell-keyword">in</span> (fn a) s'

<span class="org-comment-delimiter">{-</span>
<span class="org-comment">  A more readable version of bindSt </span>

<span class="org-comment">   -- m == step</span>
<span class="org-comment">   -- k == makeStep</span>
<span class="org-comment">   -- s == oldState </span>
<span class="org-comment">-}</span>
<span class="org-function-name">bindAlt</span> <span class="org-haskell-operator">::</span> (<span class="org-haskell-constructor">SimpleState</span> s a) <span class="org-haskell-operator">-&gt;</span> (a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">SimpleState</span> s b) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">SimpleState</span> s b
<span class="org-haskell-definition">bindAlt</span> step makeStep oldState <span class="org-haskell-operator">=</span>
  <span class="org-haskell-keyword">let</span> (result<span class="org-haskell-operator">,</span> newState) <span class="org-haskell-operator">=</span> step oldState
  <span class="org-haskell-keyword">in</span> (makeStep result) newState


<span class="org-comment-delimiter">{- </span><span class="org-comment">Get current state and returens it as result -}</span>
<span class="org-function-name">getSt</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">SimpleState</span> s s 
<span class="org-haskell-definition">getSt</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-operator">\</span>s <span class="org-haskell-operator">-&gt;</span> (s<span class="org-haskell-operator">,</span> s)

<span class="org-comment-delimiter">{- </span><span class="org-comment">Set current state and ignore the current one. -}</span>
<span class="org-function-name">putSt</span> <span class="org-haskell-operator">::</span> s <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">SimpleState</span> s <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">putSt</span> s <span class="org-haskell-operator">=</span> <span class="org-haskell-operator">\</span><span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-constructor">()</span><span class="org-haskell-operator">,</span> s)
</pre>
</div>


<p>
Running:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load ch14<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">SimpleState</span><span class="org-haskell-operator">.</span>hs 
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( ch14<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">SimpleState</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>set <span class="org-haskell-operator">+</span>m
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-comment-delimiter">-- </span><span class="org-comment">It can be pasted in Ghci </span>
<span class="org-comment-delimiter">--</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">The current state is n, the next state is </span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">n + 1, the state output is 2 * n </span>
<span class="org-comment-delimiter">--</span>

<span class="org-comment-delimiter">{-</span>
<span class="org-comment">       |---------|        |----------|       |----------|     |---------|</span>
<span class="org-comment">   ---&gt;| stateFn |----&gt;   | stateFn  |-----&gt; | stateFn  |----&gt;| stateFn |--&gt; </span>
<span class="org-comment">  1    |---------|    2   |----------|   3   |----------| 4   |---------|   5 ...</span>
<span class="org-comment">            |                   |                 |                | </span>
<span class="org-comment">            |                   |                 |                |</span>
<span class="org-comment">           \ /                 \ /               \ /              \ /</span>
<span class="org-comment">           output = 3          output = 4       output = 6        output = 8</span>
<span class="org-comment">-}</span>


<span class="org-haskell-constructor">:</span>{

<span class="org-haskell-keyword">let</span> stateFn <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">SimpleState</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">Int</span> 
    stateFn n <span class="org-haskell-operator">=</span> (2 <span class="org-haskell-operator">*</span> n<span class="org-haskell-operator">,</span> n <span class="org-haskell-operator">+</span> 1)
<span class="org-haskell-constructor">:</span>}

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t stateFn 
<span class="org-function-name">stateFn</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">SimpleState</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">Int</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> stateFn 1
(2<span class="org-haskell-operator">,</span>2)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> stateFn 2
(4<span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> stateFn 3
(6<span class="org-haskell-operator">,</span>4)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> stateFn 4
(8<span class="org-haskell-operator">,</span>5)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> stateFn 5
(10<span class="org-haskell-operator">,</span>6)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> stateFn 6
(12<span class="org-haskell-operator">,</span>7)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 


<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t returnSt 10
<span class="org-haskell-definition">returnSt</span> 10 <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Num</span> a <span class="org-haskell-operator">=&gt;</span> <span class="org-haskell-constructor">SimpleState</span> s a
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> (returnSt 10) 3
(10<span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> (returnSt 20) 4
(20<span class="org-haskell-operator">,</span>4)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> (returnSt 12) 5
(12<span class="org-haskell-operator">,</span>5)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> getSt 3
(3<span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> getSt 10
(10<span class="org-haskell-operator">,</span>10)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> (putSt 3) 4
(<span class="org-haskell-constructor">()</span><span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> (putSt 3) 4
(<span class="org-haskell-constructor">()</span><span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> (putSt 3) 5
(<span class="org-haskell-constructor">()</span><span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> (putSt 3) 10
(<span class="org-haskell-constructor">()</span><span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-8-4" class="outline-4">
<h4 id="sec-1-8-4"><span class="section-number-4">1.8.4</span> State.hs</h4>
<div class="outline-text-4" id="text-1-8-4">
<p>
Page: 349 - File: <a href="rwh/ch14/State.hs">rwh/ch14/State.hs</a> 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-comment-delimiter">{-</span>
<span class="org-comment">  Applies a state transformer to a state and returns a new state</span>
<span class="org-comment">  yielding a result. </span>
<span class="org-comment">  </span>
<span class="org-comment">  runState :: State s a -&gt; s -&gt; (a, s)</span>

<span class="org-comment"> -}</span>
<span class="org-haskell-keyword">newtype</span> <span class="org-haskell-constructor">State</span> s a <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">State</span> { runState <span class="org-haskell-operator">::</span> s <span class="org-haskell-operator">-&gt;</span> (a<span class="org-haskell-operator">,</span> s)  }


<span class="org-function-name">returnState</span> <span class="org-haskell-operator">::</span> a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">State</span> s a
<span class="org-haskell-definition">returnState</span> a <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">State</span> ( <span class="org-haskell-operator">\</span>s <span class="org-haskell-operator">-&gt;</span> (a<span class="org-haskell-operator">,</span> s) )

<span class="org-function-name">bindState</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">State</span> s a <span class="org-haskell-operator">-&gt;</span> (a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">State</span> s b) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">State</span> s b
<span class="org-haskell-definition">bindState</span> m fn <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">State</span> <span class="org-haskell-operator">$</span> <span class="org-haskell-operator">\</span>s <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-keyword">let</span> (a<span class="org-haskell-operator">,</span> s') <span class="org-haskell-operator">=</span> runState m s
                               <span class="org-haskell-keyword">in</span> runState (fn a) s'

<span class="org-comment-delimiter">-- </span><span class="org-comment">evalState : Returns only the result, throwing away the final state</span>
<span class="org-comment-delimiter">--</span>
<span class="org-function-name">evalState</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">State</span> s a <span class="org-haskell-operator">-&gt;</span> s <span class="org-haskell-operator">-&gt;</span> a
<span class="org-haskell-definition">evalState</span> fn s <span class="org-haskell-operator">=</span> fst (runState fn s)

<span class="org-comment-delimiter">-- </span><span class="org-comment">execState : Throws the result away, returning only the final state</span>
<span class="org-function-name">execState</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">State</span> s a <span class="org-haskell-operator">-&gt;</span> s <span class="org-haskell-operator">-&gt;</span> s
<span class="org-haskell-definition">execState</span> fn s <span class="org-haskell-operator">=</span> snd (runState fn s)


<span class="org-function-name">get</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">State</span> s s
<span class="org-haskell-definition">get</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">State</span> (<span class="org-haskell-operator">\</span>s <span class="org-haskell-operator">-&gt;</span> (s<span class="org-haskell-operator">,</span> s))

<span class="org-function-name">put</span> <span class="org-haskell-operator">::</span> s <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">State</span> s <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">put</span> s <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">State</span> (<span class="org-haskell-operator">\</span> <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-constructor">()</span><span class="org-haskell-operator">,</span> s))

<span class="org-comment-delimiter">{- </span><span class="org-comment">State Monad Evaluation Functions -}</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">runState : Returns both the result and the final state</span>



<span class="org-comment-delimiter">{- </span><span class="org-comment">State Monad Evaluation Functions -}</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">runState : Returns both the result and the final state</span>



<span class="org-comment-delimiter">{-</span>
<span class="org-comment">   Applies a function to the result of the</span>
<span class="org-comment">   state transformer (state monad) application</span>
<span class="org-comment">   keeping the current state. </span>

<span class="org-comment">-}</span>
<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Functor</span> (<span class="org-haskell-constructor">State</span> s) <span class="org-haskell-keyword">where</span>
  
  <span class="org-comment-delimiter">{- </span><span class="org-comment">fmap :: (a -&gt; b) -&gt; F a -&gt; F b -}</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">fmap :: (a -&gt; b) -&gt; State s a -&gt; State s b</span>
  fmap f fns <span class="org-haskell-operator">=</span>
    <span class="org-haskell-constructor">State</span> <span class="org-haskell-operator">$</span> <span class="org-haskell-operator">\</span>oldState <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-keyword">let</span> (output<span class="org-haskell-operator">,</span> newState) <span class="org-haskell-operator">=</span> runState fns oldState
                         <span class="org-haskell-keyword">in</span> (f output<span class="org-haskell-operator">,</span> newState)
                 


<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Applicative</span> (<span class="org-haskell-constructor">State</span> s) <span class="org-haskell-keyword">where</span>
  
  pure <span class="org-haskell-operator">=</span> returnState

  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">(&lt;*&gt;) :: State s (a -&gt; b) -&gt; State s a -&gt; State s b</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">fsa :: State s a</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">fn :: State s (a -&gt; b)</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">output :: a </span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">newState :: s</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">f_a_to_b :: a -&gt; b</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">newState' :: s</span>
  <span class="org-comment-delimiter">--</span>
  fn <span class="org-haskell-operator">&lt;*&gt;</span> fsa <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">State</span> <span class="org-haskell-operator">$</span> <span class="org-haskell-operator">\</span> oldState <span class="org-haskell-operator">-&gt;</span>
    <span class="org-haskell-keyword">let</span> (output<span class="org-haskell-operator">,</span> newState) <span class="org-haskell-operator">=</span> runState fsa oldState <span class="org-haskell-keyword">in</span>
    <span class="org-haskell-keyword">let</span> (f_a_to_b<span class="org-haskell-operator">,</span> newState') <span class="org-haskell-operator">=</span> runState fn newState <span class="org-haskell-keyword">in</span>
    (f_a_to_b output<span class="org-haskell-operator">,</span> newState')


               

<span class="org-haskell-keyword">instance</span> <span class="org-haskell-constructor">Monad</span> (<span class="org-haskell-constructor">State</span> s) <span class="org-haskell-keyword">where</span>

  <span class="org-comment-delimiter">-- </span><span class="org-comment">return :: a -&gt; State s a </span>
  <span class="org-comment-delimiter">--</span>
  return a <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">State</span> <span class="org-haskell-operator">$</span> <span class="org-haskell-operator">\</span>s <span class="org-haskell-operator">-&gt;</span>  (a<span class="org-haskell-operator">,</span> s)   
  
  <span class="org-comment-delimiter">-- </span><span class="org-comment">(&gt;&gt;=) :: State s a -&gt; (a -&gt; State s b) -&gt; State s b</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">StateFn    :: State s a</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">stateMaker :: a -&gt; State s b </span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">result     :: a</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">newState   :: s </span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">--  </span>
  <span class="org-comment-delimiter">--</span>
  stateFn <span class="org-haskell-operator">&gt;&gt;=</span> stateMaker  <span class="org-haskell-operator">=</span>

    <span class="org-haskell-constructor">State</span> <span class="org-haskell-operator">$</span> <span class="org-haskell-operator">\</span>oldState <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-keyword">let</span> (result<span class="org-haskell-operator">,</span> newState) <span class="org-haskell-operator">=</span> runState stateFn oldState
                         <span class="org-haskell-keyword">in</span>  runState (stateMaker result) newState
</pre>
</div>


<p>
Running: 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load ch14<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">State</span><span class="org-haskell-operator">.</span>hs 
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( ch14<span class="org-haskell-operator">/</span><span class="org-haskell-constructor">State</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>set <span class="org-haskell-operator">+</span>m
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-keyword">let</span> stateFn1 <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">State</span> (<span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> (2 <span class="org-haskell-operator">*</span> x<span class="org-haskell-operator">,</span> x <span class="org-haskell-operator">+</span> 1)) <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">State</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">Int</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t stateFn1 
<span class="org-function-name">stateFn1</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">State</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">Int</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 


<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn1 0
(0<span class="org-haskell-operator">,</span>1)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn1 1
(2<span class="org-haskell-operator">,</span>2)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn1 2
(4<span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn1 3
(6<span class="org-haskell-operator">,</span>4)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn1 4
(8<span class="org-haskell-operator">,</span>5)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn1 5
(10<span class="org-haskell-operator">,</span>6)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (fmap (<span class="org-haskell-operator">*</span>2) stateFn1) 0
(0<span class="org-haskell-operator">,</span>1)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (fmap (<span class="org-haskell-operator">*</span>2) stateFn1) 1
(4<span class="org-haskell-operator">,</span>2)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (fmap (<span class="org-haskell-operator">*</span>2) stateFn1) 2
(8<span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (fmap (<span class="org-haskell-operator">*</span>2) stateFn1) 3
(12<span class="org-haskell-operator">,</span>4)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (fmap (<span class="org-haskell-operator">*</span>2) stateFn1) 4
(16<span class="org-haskell-operator">,</span>5)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (fmap (<span class="org-haskell-operator">*</span>2) stateFn1) 5
(20<span class="org-haskell-operator">,</span>6)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 


<span class="org-comment-delimiter">{- </span><span class="org-comment">stateFn in monadic notation</span>
<span class="org-comment">   This block can be copied in the repl.</span>
<span class="org-comment">-}</span>

<span class="org-haskell-constructor">:</span>{
<span class="org-haskell-keyword">let</span> stateFn2 <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">State</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">Int</span>
    stateFn2 <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
      sc <span class="org-haskell-operator">&lt;-</span> get
      put (sc <span class="org-haskell-operator">+</span> 1)
      return <span class="org-haskell-operator">$</span> 2 <span class="org-haskell-operator">*</span> sc

<span class="org-haskell-constructor">:</span>}

<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>t stateFn2
<span class="org-function-name">stateFn2</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">State</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">Int</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn2 0
(0<span class="org-haskell-operator">,</span>1)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn2 1
(2<span class="org-haskell-operator">,</span>2)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn2 2
(4<span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn2 3
(6<span class="org-haskell-operator">,</span>4)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn2 4
(8<span class="org-haskell-operator">,</span>5)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn2 5
(10<span class="org-haskell-operator">,</span>6)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-comment-delimiter">{- </span><span class="org-comment">stateFn3   -}</span>

<span class="org-haskell-constructor">:</span>{
<span class="org-haskell-keyword">let</span> stateFn3 <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">State</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-constructor">Int</span>
    stateFn3 <span class="org-haskell-operator">=</span>
      get          <span class="org-haskell-operator">&gt;&gt;=</span> <span class="org-haskell-operator">\</span> sc <span class="org-haskell-operator">-&gt;</span>
      put (sc <span class="org-haskell-operator">+</span> 1) <span class="org-haskell-operator">&gt;&gt;=</span> <span class="org-haskell-operator">\</span><span class="org-haskell-keyword">_</span>   <span class="org-haskell-operator">-&gt;</span>
      return (2 <span class="org-haskell-operator">*</span> sc)
      
<span class="org-haskell-constructor">:</span>}

<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn3 0
(0<span class="org-haskell-operator">,</span>1)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn3 1
(2<span class="org-haskell-operator">,</span>2)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn3 2
(4<span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn3 3
(6<span class="org-haskell-operator">,</span>4)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn3 4
(8<span class="org-haskell-operator">,</span>5)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState stateFn3 5
(10<span class="org-haskell-operator">,</span>6)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (replicateM 10 stateFn3) 0
([18<span class="org-haskell-operator">,</span>16<span class="org-haskell-operator">,</span>14<span class="org-haskell-operator">,</span>12<span class="org-haskell-operator">,</span>10<span class="org-haskell-operator">,</span>8<span class="org-haskell-operator">,</span>6<span class="org-haskell-operator">,</span>4<span class="org-haskell-operator">,</span>2<span class="org-haskell-operator">,</span>0]<span class="org-haskell-operator">,</span>10)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (replicateM 0 stateFn3) 0
(<span class="org-haskell-constructor">[]</span><span class="org-haskell-operator">,</span>0)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (replicateM 1 stateFn3) 0
([0]<span class="org-haskell-operator">,</span>1)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (replicateM 2 stateFn3) 0
([2<span class="org-haskell-operator">,</span>0]<span class="org-haskell-operator">,</span>2)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (replicateM 3 stateFn3) 0
([4<span class="org-haskell-operator">,</span>2<span class="org-haskell-operator">,</span>0]<span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (replicateM 4 stateFn3) 0
([6<span class="org-haskell-operator">,</span>4<span class="org-haskell-operator">,</span>2<span class="org-haskell-operator">,</span>0]<span class="org-haskell-operator">,</span>4)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState (replicateM 10 stateFn3) 0
([18<span class="org-haskell-operator">,</span>16<span class="org-haskell-operator">,</span>14<span class="org-haskell-operator">,</span>12<span class="org-haskell-operator">,</span>10<span class="org-haskell-operator">,</span>8<span class="org-haskell-operator">,</span>6<span class="org-haskell-operator">,</span>4<span class="org-haskell-operator">,</span>2<span class="org-haskell-operator">,</span>0]<span class="org-haskell-operator">,</span>10)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 


<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState ((<span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> x <span class="org-haskell-operator">+</span> 3) <span class="org-haskell-operator">&lt;$&gt;</span>  stateFn3) 0
(3<span class="org-haskell-operator">,</span>1)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState ((<span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> x <span class="org-haskell-operator">+</span> 3) <span class="org-haskell-operator">&lt;$&gt;</span>  stateFn3) 1
(5<span class="org-haskell-operator">,</span>2)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState ((<span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> x <span class="org-haskell-operator">+</span> 3) <span class="org-haskell-operator">&lt;$&gt;</span>  stateFn3) 2
(7<span class="org-haskell-operator">,</span>3)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState ((<span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> x <span class="org-haskell-operator">+</span> 3) <span class="org-haskell-operator">&lt;$&gt;</span>  stateFn3) 3
(9<span class="org-haskell-operator">,</span>4)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> runState ((<span class="org-haskell-operator">\</span>x <span class="org-haskell-operator">-&gt;</span> x <span class="org-haskell-operator">+</span> 3) <span class="org-haskell-operator">&lt;$&gt;</span>  stateFn3) 4
(11<span class="org-haskell-operator">,</span>5)
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-1-9" class="outline-3">
<h3 id="sec-1-9"><span class="section-number-3">1.9</span> Chapter 27 - Sockets and Syslog</h3>
<div class="outline-text-3" id="text-1-9">
</div><div id="outline-container-sec-1-9-1" class="outline-4">
<h4 id="sec-1-9-1"><span class="section-number-4">1.9.1</span> Requirements</h4>
<div class="outline-text-4" id="text-1-9-1">
<ul class="org-ul">
<li><a href="https://hackage.haskell.org/package/network-2.6.2.1">Network Package</a>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-9-2" class="outline-4">
<h4 id="sec-1-9-2"><span class="section-number-4">1.9.2</span> UDP Syslog Server and Client</h4>
<div class="outline-text-4" id="text-1-9-2">
<p>
Page 611 - File: <a href="rwh/ch27/syslogclient.hs">rwh/ch27/syslogclient.hs</a> 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-comment-delimiter">-- </span><span class="org-comment">file: ch27/syslogclient.hs</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.Bits</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Network.Socket</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Network.BSD</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.List</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">SyslogTypes</span>


<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">SyslogHandle</span> <span class="org-haskell-operator">=</span> 
    <span class="org-haskell-constructor">SyslogHandle</span> {slSocket <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Socket</span><span class="org-haskell-operator">,</span>
                  slProgram <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span><span class="org-haskell-operator">,</span>
                  slAddress <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">SockAddr</span>}

<span class="org-function-name">openlog</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">HostName</span>             <span class="org-doc">-- ^ Remote hostname, or localhost</span>
        <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span>               <span class="org-doc">-- ^ Port number or name; 514 is default</span>
        <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span>               <span class="org-doc">-- ^ Name to log under</span>
        <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">SyslogHandle</span>      <span class="org-doc">-- ^ Handle to use for logging</span>

<span class="org-haskell-definition">openlog</span> hostname port progname <span class="org-haskell-operator">=</span>
    <span class="org-haskell-keyword">do</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">Look up the hostname and port.  Either raises an exception</span>
       <span class="org-comment-delimiter">-- </span><span class="org-comment">or returns a nonempty list.  First element in that list</span>
       <span class="org-comment-delimiter">-- </span><span class="org-comment">is supposed to be the best option.</span>
       addrinfos <span class="org-haskell-operator">&lt;-</span> getAddrInfo <span class="org-haskell-constructor">Nothing</span> (<span class="org-haskell-constructor">Just</span> hostname) (<span class="org-haskell-constructor">Just</span> port)
       <span class="org-haskell-keyword">let</span> serveraddr <span class="org-haskell-operator">=</span> head addrinfos
      
       <span class="org-comment-delimiter">-- </span><span class="org-comment">Establish a socket for communication</span>
       sock <span class="org-haskell-operator">&lt;-</span> socket (addrFamily serveraddr) <span class="org-haskell-constructor">Datagram</span> defaultProtocol

       <span class="org-comment-delimiter">-- </span><span class="org-comment">Save off the socket, program name, and server address in a handle</span>
       return <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">SyslogHandle</span> sock progname (addrAddress serveraddr)


<span class="org-function-name">syslog</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">SyslogHandle</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Facility</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Priority</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">syslog</span> syslogh fac pri msg <span class="org-haskell-operator">=</span>
    sendstr sendmsg
    <span class="org-haskell-keyword">where</span> code <span class="org-haskell-operator">=</span> makeCode fac pri
          sendmsg <span class="org-haskell-operator">=</span> <span class="org-string">"&lt;"</span> <span class="org-haskell-operator">++</span> show code <span class="org-haskell-operator">++</span> <span class="org-string">"&gt;"</span> <span class="org-haskell-operator">++</span> (slProgram syslogh) <span class="org-haskell-operator">++</span>
                    <span class="org-string">": "</span> <span class="org-haskell-operator">++</span> msg
          <span class="org-comment-delimiter">-- </span><span class="org-comment">Send until everything is done</span>
          sendstr <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">()</span>
          sendstr <span class="org-haskell-constructor">[]</span> <span class="org-haskell-operator">=</span> return <span class="org-haskell-constructor">()</span>
          sendstr omsg <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span> sent <span class="org-haskell-operator">&lt;-</span> sendTo (slSocket syslogh) omsg
                                    (slAddress syslogh)
                            sendstr (genericDrop sent omsg)


<span class="org-function-name">closelog</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">SyslogHandle</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">closelog</span> syslogh <span class="org-haskell-operator">=</span> sClose (slSocket syslogh)


<span class="org-doc">{- | Convert a facility and a priority into a syslog code -}</span>
<span class="org-function-name">makeCode</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Facility</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Priority</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int</span>
<span class="org-haskell-definition">makeCode</span> fac pri <span class="org-haskell-operator">=</span>
    <span class="org-haskell-keyword">let</span> faccode <span class="org-haskell-operator">=</span> codeOfFac fac
        pricode <span class="org-haskell-operator">=</span> fromEnum pri 
        <span class="org-haskell-keyword">in</span>
          (faccode <span class="org-haskell-operator">`shiftL`</span> 3) <span class="org-haskell-operator">.|.</span> pricode
</pre>
</div>


<p>
File: <a href="rwh/ch27/SyslogTypes.hs">rwh/ch27/SyslogTypes.hs</a> 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">module</span> <span class="org-haskell-constructor">SyslogTypes</span> <span class="org-haskell-keyword">where</span>
<span class="org-doc">{- | Priorities define how important a log message is. -}</span>

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">Priority</span> <span class="org-haskell-operator">=</span> 
            <span class="org-haskell-constructor">DEBUG</span>                   <span class="org-doc">-- ^ Debug messages</span>
          <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">INFO</span>                    <span class="org-doc">-- ^ Information</span>
          <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">NOTICE</span>                  <span class="org-doc">-- ^ Normal runtime conditions</span>
          <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">WARNING</span>                 <span class="org-doc">-- ^ General Warnings</span>
          <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">ERROR</span>                   <span class="org-doc">-- ^ General Errors</span>
          <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">CRITICAL</span>                <span class="org-doc">-- ^ Severe situations</span>
          <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">ALERT</span>                   <span class="org-doc">-- ^ Take immediate action</span>
          <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">EMERGENCY</span>               <span class="org-doc">-- ^ System is unusable</span>
                    <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Eq</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Ord</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Show</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Read</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Enum</span>)

<span class="org-doc">{- | Facilities are used by the system to determine where messages</span>
<span class="org-doc">are sent. -}</span>

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">Facility</span> <span class="org-haskell-operator">=</span> 
              <span class="org-haskell-constructor">KERN</span>                      <span class="org-doc">-- ^ Kernel messages</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">USER</span>                    <span class="org-doc">-- ^ General userland messages</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">MAIL</span>                    <span class="org-doc">-- ^ E-Mail system</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">DAEMON</span>                  <span class="org-doc">-- ^ Daemon (server process) messages</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">AUTH</span>                    <span class="org-doc">-- ^ Authentication or security messages</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">SYSLOG</span>                  <span class="org-doc">-- ^ Internal syslog messages</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">LPR</span>                     <span class="org-doc">-- ^ Printer messages</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">NEWS</span>                    <span class="org-doc">-- ^ Usenet news</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">UUCP</span>                    <span class="org-doc">-- ^ UUCP messages</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">CRON</span>                    <span class="org-doc">-- ^ Cron messages</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">AUTHPRIV</span>                <span class="org-doc">-- ^ Private authentication messages</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">FTP</span>                     <span class="org-doc">-- ^ FTP messages</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">LOCAL0</span>                  
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">LOCAL1</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">LOCAL2</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">LOCAL3</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">LOCAL4</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">LOCAL5</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">LOCAL6</span>
              <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">LOCAL7</span>
                <span class="org-haskell-keyword">deriving</span> (<span class="org-haskell-constructor">Eq</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Show</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Read</span>)

<span class="org-haskell-definition">facToCode</span> <span class="org-haskell-operator">=</span> [ 
                       (<span class="org-haskell-constructor">KERN</span><span class="org-haskell-operator">,</span> 0)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">USER</span><span class="org-haskell-operator">,</span> 1)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">MAIL</span><span class="org-haskell-operator">,</span> 2)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">DAEMON</span><span class="org-haskell-operator">,</span> 3)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">AUTH</span><span class="org-haskell-operator">,</span> 4)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">SYSLOG</span><span class="org-haskell-operator">,</span> 5)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">LPR</span><span class="org-haskell-operator">,</span> 6)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">NEWS</span><span class="org-haskell-operator">,</span> 7)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">UUCP</span><span class="org-haskell-operator">,</span> 8)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">CRON</span><span class="org-haskell-operator">,</span> 9)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">AUTHPRIV</span><span class="org-haskell-operator">,</span> 10)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">FTP</span><span class="org-haskell-operator">,</span> 11)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">LOCAL0</span><span class="org-haskell-operator">,</span> 16)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">LOCAL1</span><span class="org-haskell-operator">,</span> 17)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">LOCAL2</span><span class="org-haskell-operator">,</span> 18)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">LOCAL3</span><span class="org-haskell-operator">,</span> 19)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">LOCAL4</span><span class="org-haskell-operator">,</span> 20)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">LOCAL5</span><span class="org-haskell-operator">,</span> 21)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">LOCAL6</span><span class="org-haskell-operator">,</span> 22)<span class="org-haskell-operator">,</span>
                       (<span class="org-haskell-constructor">LOCAL7</span><span class="org-haskell-operator">,</span> 23)

           ]


<span class="org-haskell-definition">codeToFac</span> <span class="org-haskell-operator">=</span> map (<span class="org-haskell-operator">\</span>(x<span class="org-haskell-operator">,</span> y) <span class="org-haskell-operator">-&gt;</span> (y<span class="org-haskell-operator">,</span> x)) facToCode


<span class="org-doc">{- | We can't use enum here because the numbering is discontiguous -}</span>
<span class="org-function-name">codeOfFac</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Facility</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int</span>
<span class="org-haskell-definition">codeOfFac</span> f <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">case</span> lookup f facToCode <span class="org-haskell-keyword">of</span>
                <span class="org-haskell-constructor">Just</span> x <span class="org-haskell-operator">-&gt;</span> x
                <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> error <span class="org-haskell-operator">$</span> <span class="org-string">"Internal error in codeOfFac"</span>

<span class="org-function-name">facOfCode</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Int</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Facility</span>
<span class="org-haskell-definition">facOfCode</span> f <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">case</span> lookup f codeToFac <span class="org-haskell-keyword">of</span>
                <span class="org-haskell-constructor">Just</span> x <span class="org-haskell-operator">-&gt;</span> x
                <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> error <span class="org-haskell-operator">$</span> <span class="org-string">"Invalid code in facOfCode"</span>
</pre>
</div>

<p>
File: <a href="rwh/ch27/syslogserver.hs">rwh/ch27/syslogserver.hs</a> 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.Bits</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Network.Socket</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Network.BSD</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.List</span>

<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">HandlerFunc</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">SockAddr</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">()</span>

<span class="org-function-name">serveLog</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span>              <span class="org-doc">-- ^ Port number or name; 514 is default</span>
         <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">HandlerFunc</span>         <span class="org-doc">-- ^ Function to handle incoming messages</span>
         <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">()</span>

<span class="org-haskell-definition">serveLog</span> port handlerfunc <span class="org-haskell-operator">=</span> withSocketsDo <span class="org-haskell-operator">$</span>
    <span class="org-haskell-keyword">do</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">Look up the port.  Either raises an exception or returns</span>
       <span class="org-comment-delimiter">-- </span><span class="org-comment">a nonempty list.  </span>
       addrinfos <span class="org-haskell-operator">&lt;-</span> getAddrInfo 
                    (<span class="org-haskell-constructor">Just</span> (defaultHints {addrFlags <span class="org-haskell-operator">=</span> [<span class="org-haskell-constructor">AI_PASSIVE</span>]}))
                    <span class="org-haskell-constructor">Nothing</span> (<span class="org-haskell-constructor">Just</span> port)
       <span class="org-haskell-keyword">let</span> serveraddr <span class="org-haskell-operator">=</span> head addrinfos
       <span class="org-comment-delimiter">-- </span><span class="org-comment">Create a socket</span>
       sock <span class="org-haskell-operator">&lt;-</span> socket (addrFamily serveraddr) <span class="org-haskell-constructor">Datagram</span> defaultProtocol
       <span class="org-comment-delimiter">-- </span><span class="org-comment">Bind it to the address we're listening to</span>
       bindSocket sock (addrAddress serveraddr)
       <span class="org-comment-delimiter">-- </span><span class="org-comment">Loop forever processing incoming data.  Ctrl-C to abort.</span>
       procMessages sock
    <span class="org-haskell-keyword">where</span> procMessages sock <span class="org-haskell-operator">=</span>
              <span class="org-haskell-keyword">do</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">Receive one UDP packet, maximum length 1024 bytes,</span>
                 <span class="org-comment-delimiter">-- </span><span class="org-comment">and save its content into msg and its source</span>
                 <span class="org-comment-delimiter">-- </span><span class="org-comment">IP and port into addr</span>
                 (msg<span class="org-haskell-operator">,</span> <span class="org-haskell-keyword">_</span><span class="org-haskell-operator">,</span> addr) <span class="org-haskell-operator">&lt;-</span> recvFrom sock 1024
                 <span class="org-comment-delimiter">-- </span><span class="org-comment">Handle it</span>
                 handlerfunc addr msg
                 <span class="org-comment-delimiter">-- </span><span class="org-comment">And process more messages</span>
                 procMessages sock

<span class="org-comment-delimiter">-- </span><span class="org-comment">A simple handler that prints incoming packets</span>
<span class="org-function-name">plainHandler</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">HandlerFunc</span>
<span class="org-haskell-definition">plainHandler</span> addr msg <span class="org-haskell-operator">=</span> 
    putStrLn <span class="org-haskell-operator">$</span> <span class="org-string">"From "</span> <span class="org-haskell-operator">++</span> show addr <span class="org-haskell-operator">++</span> <span class="org-string">": "</span> <span class="org-haskell-operator">++</span> msg
</pre>
</div>

<p>
Running:
</p>

<p>
This app loaded in GHCI without any errors, however it didn't work the
server printed nothing. It was tested in GHC/GHCI Version 7.10.2, Arch
Linux 64 bits, Linux version 4.4.3-1-ARCH.
</p>
</div>
</div>

<div id="outline-container-sec-1-9-3" class="outline-4">
<h4 id="sec-1-9-3"><span class="section-number-4">1.9.3</span> TCP Syslog Server and Client</h4>
<div class="outline-text-4" id="text-1-9-3">
<p>
Page 617 - File: <a href="rwh/ch27/syslogtcpserver.hs">rwh/ch27/syslogtcpserver.hs</a> 
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.Bits</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Network.Socket</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Network.BSD</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.List</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Control.Concurrent</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Control.Concurrent.MVar</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">System.IO</span>


<span class="org-haskell-keyword">type</span> <span class="org-haskell-constructor">HandlerFunc</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">SockAddr</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">()</span>

<span class="org-function-name">serveLog</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span>              <span class="org-doc">-- ^ Port number or name; 514 is default</span>
         <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">HandlerFunc</span>         <span class="org-doc">-- ^ Function to handle incoming messages</span>
         <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">serveLog</span> port handlerfunc <span class="org-haskell-operator">=</span> withSocketsDo <span class="org-haskell-operator">$</span>
    <span class="org-haskell-keyword">do</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">Look up the port.  Either raises an exception or returns</span>
       <span class="org-comment-delimiter">-- </span><span class="org-comment">a nonempty list.  </span>
       addrinfos <span class="org-haskell-operator">&lt;-</span> getAddrInfo 
                    (<span class="org-haskell-constructor">Just</span> (defaultHints {addrFlags <span class="org-haskell-operator">=</span> [<span class="org-haskell-constructor">AI_PASSIVE</span>]}))
                    <span class="org-haskell-constructor">Nothing</span> (<span class="org-haskell-constructor">Just</span> port)
       <span class="org-haskell-keyword">let</span> serveraddr <span class="org-haskell-operator">=</span> head addrinfos
       <span class="org-comment-delimiter">-- </span><span class="org-comment">Create a socket</span>
       sock <span class="org-haskell-operator">&lt;-</span> socket (addrFamily serveraddr) <span class="org-haskell-constructor">Stream</span> defaultProtocol
       <span class="org-comment-delimiter">-- </span><span class="org-comment">Bind it to the address we're listening to</span>
       bindSocket sock (addrAddress serveraddr)
       <span class="org-comment-delimiter">-- </span><span class="org-comment">Start listening for connection requests.  Maximum queue size</span>
       <span class="org-comment-delimiter">-- </span><span class="org-comment">of 5 connection requests waiting to be accepted.</span>
       listen sock 5
       <span class="org-comment-delimiter">-- </span><span class="org-comment">Create a lock to use for synchronizing access to the handler</span>
       lock <span class="org-haskell-operator">&lt;-</span> newMVar <span class="org-haskell-constructor">()</span>
       <span class="org-comment-delimiter">-- </span><span class="org-comment">Loop forever waiting for connections.  Ctrl-C to abort.</span>
       procRequests lock sock
    <span class="org-haskell-keyword">where</span>
          <span class="org-doc">-- | Process incoming connection requests</span>
          procRequests <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">MVar</span> <span class="org-haskell-constructor">()</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Socket</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">()</span>
          procRequests lock mastersock <span class="org-haskell-operator">=</span> 
              <span class="org-haskell-keyword">do</span> (connsock<span class="org-haskell-operator">,</span> clientaddr) <span class="org-haskell-operator">&lt;-</span> accept mastersock
                 handle lock clientaddr
                    <span class="org-string">"syslogtcpserver.hs: client connnected"</span>
                 forkIO <span class="org-haskell-operator">$</span> procMessages lock connsock clientaddr
                 procRequests lock mastersock

          <span class="org-doc">-- | Process incoming messages</span>
          procMessages <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">MVar</span> <span class="org-haskell-constructor">()</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Socket</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">SockAddr</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">()</span>
          procMessages lock connsock clientaddr <span class="org-haskell-operator">=</span>
              <span class="org-haskell-keyword">do</span> connhdl <span class="org-haskell-operator">&lt;-</span> socketToHandle connsock <span class="org-haskell-constructor">ReadMode</span>
                 hSetBuffering connhdl <span class="org-haskell-constructor">LineBuffering</span>
                 messages <span class="org-haskell-operator">&lt;-</span> hGetContents connhdl
                 mapM_ (handle lock clientaddr) (lines messages)
                 hClose connhdl
                 handle lock clientaddr 
                    <span class="org-string">"syslogtcpserver.hs: client disconnected"</span>
          <span class="org-comment-delimiter">-- </span><span class="org-comment">Lock the handler before passing data to it.</span>
          handle <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">MVar</span> <span class="org-haskell-constructor">()</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">HandlerFunc</span>
          <span class="org-comment-delimiter">-- </span><span class="org-comment">This type is the same as</span>
          <span class="org-comment-delimiter">-- </span><span class="org-comment">handle :: MVar () -&gt; SockAddr -&gt; String -&gt; IO ()</span>
          handle lock clientaddr msg <span class="org-haskell-operator">=</span>
              withMVar lock 
                 (<span class="org-haskell-operator">\</span>a <span class="org-haskell-operator">-&gt;</span> handlerfunc clientaddr msg <span class="org-haskell-operator">&gt;&gt;</span> return a)

<span class="org-comment-delimiter">-- </span><span class="org-comment">A simple handler that prints incoming packets</span>
<span class="org-function-name">plainHandler</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">HandlerFunc</span>
<span class="org-haskell-definition">plainHandler</span> addr msg <span class="org-haskell-operator">=</span> 
    putStrLn <span class="org-haskell-operator">$</span> <span class="org-string">"From "</span> <span class="org-haskell-operator">++</span> show addr <span class="org-haskell-operator">++</span> <span class="org-string">": "</span> <span class="org-haskell-operator">++</span> msg
</pre>
</div>


<p>
File: <a href="rwh/ch27/syslogtcpserver.hs">rwh/ch27/syslogtcpserver.hs</a> 
</p>


<div class="org-src-container">

<pre class="src src-haskell"><span class="org-comment-delimiter">-- </span><span class="org-comment">file: ch27/syslogtcpclient.hs</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.Bits</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Network.Socket</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Network.BSD</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">Data.List</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">SyslogTypes</span>
<span class="org-haskell-keyword">import</span> <span class="org-haskell-constructor">System.IO</span>

<span class="org-haskell-keyword">data</span> <span class="org-haskell-constructor">SyslogHandle</span> <span class="org-haskell-operator">=</span> 
    <span class="org-haskell-constructor">SyslogHandle</span> {slHandle <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Handle</span><span class="org-haskell-operator">,</span>
                  slProgram <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">String</span>}

<span class="org-function-name">openlog</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">HostName</span>             <span class="org-doc">-- ^ Remote hostname, or localhost</span>
        <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span>               <span class="org-doc">-- ^ Port number or name; 514 is default</span>
        <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span>               <span class="org-doc">-- ^ Name to log under</span>
        <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">SyslogHandle</span>      <span class="org-doc">-- ^ Handle to use for logging</span>

<span class="org-haskell-definition">openlog</span> hostname port progname <span class="org-haskell-operator">=</span>
    <span class="org-haskell-keyword">do</span> <span class="org-comment-delimiter">-- </span><span class="org-comment">Look up the hostname and port.  Either raises an exception</span>
       <span class="org-comment-delimiter">-- </span><span class="org-comment">or returns a nonempty list.  First element in that list</span>
       <span class="org-comment-delimiter">-- </span><span class="org-comment">is supposed to be the best option.</span>
       addrinfos <span class="org-haskell-operator">&lt;-</span> getAddrInfo <span class="org-haskell-constructor">Nothing</span> (<span class="org-haskell-constructor">Just</span> hostname) (<span class="org-haskell-constructor">Just</span> port)
       <span class="org-haskell-keyword">let</span> serveraddr <span class="org-haskell-operator">=</span> head addrinfos

       <span class="org-comment-delimiter">-- </span><span class="org-comment">Establish a socket for communication</span>
       sock <span class="org-haskell-operator">&lt;-</span> socket (addrFamily serveraddr) <span class="org-haskell-constructor">Stream</span> defaultProtocol

       <span class="org-comment-delimiter">-- </span><span class="org-comment">Mark the socket for keep-alive handling since it may be idle</span>
       <span class="org-comment-delimiter">-- </span><span class="org-comment">for long periods of time</span>
       setSocketOption sock <span class="org-haskell-constructor">KeepAlive</span> 1

       <span class="org-comment-delimiter">-- </span><span class="org-comment">Connect to server</span>
       connect sock (addrAddress serveraddr)

       <span class="org-comment-delimiter">-- </span><span class="org-comment">Make a Handle out of it for convenience</span>
       h <span class="org-haskell-operator">&lt;-</span> socketToHandle sock <span class="org-haskell-constructor">WriteMode</span>

       <span class="org-comment-delimiter">-- </span><span class="org-comment">We're going to set buffering to BlockBuffering and then</span>
       <span class="org-comment-delimiter">-- </span><span class="org-comment">explicitly call hFlush after each message, below, so that</span>
       <span class="org-comment-delimiter">-- </span><span class="org-comment">messages get logged immediately</span>
       hSetBuffering h (<span class="org-haskell-constructor">BlockBuffering</span> <span class="org-haskell-constructor">Nothing</span>)

       <span class="org-comment-delimiter">-- </span><span class="org-comment">Save off the socket, program name, and server address in a handle</span>
       return <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">SyslogHandle</span> h progname



<span class="org-function-name">syslog</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">SyslogHandle</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Facility</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Priority</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">syslog</span> syslogh fac pri msg <span class="org-haskell-operator">=</span>
    <span class="org-haskell-keyword">do</span> hPutStrLn (slHandle syslogh) sendmsg
       <span class="org-comment-delimiter">-- </span><span class="org-comment">Make sure that we send data immediately</span>
       hFlush (slHandle syslogh)
    <span class="org-haskell-keyword">where</span> code <span class="org-haskell-operator">=</span> makeCode fac pri
          sendmsg <span class="org-haskell-operator">=</span> <span class="org-string">"&lt;"</span> <span class="org-haskell-operator">++</span> show code <span class="org-haskell-operator">++</span> <span class="org-string">"&gt;"</span> <span class="org-haskell-operator">++</span> (slProgram syslogh) <span class="org-haskell-operator">++</span>
                    <span class="org-string">": "</span> <span class="org-haskell-operator">++</span> msg

<span class="org-function-name">closelog</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">SyslogHandle</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">IO</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">closelog</span> syslogh <span class="org-haskell-operator">=</span> hClose (slHandle syslogh)

<span class="org-doc">{- | Convert a facility and a priority into a syslog code -}</span>
<span class="org-function-name">makeCode</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-constructor">Facility</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Priority</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-constructor">Int</span>
<span class="org-haskell-definition">makeCode</span> fac pri <span class="org-haskell-operator">=</span>
    <span class="org-haskell-keyword">let</span> faccode <span class="org-haskell-operator">=</span> codeOfFac fac
        pricode <span class="org-haskell-operator">=</span> fromEnum pri 
        <span class="org-haskell-keyword">in</span>
          (faccode <span class="org-haskell-operator">`shiftL`</span> 3) <span class="org-haskell-operator">.|.</span> pricode
</pre>
</div>


<p>
Running: syslogtcpserver with telnet as client:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"syslogtcpserver.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( syslogtcpserver<span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-comment-delimiter">--  </span><span class="org-comment">Open another terminal window </span>
<span class="org-comment-delimiter">--  </span><span class="org-comment">and enter: </span>
<span class="org-comment-delimiter">--</span>
<span class="org-comment-delimiter">--  </span><span class="org-comment">$ telnet localhost 10514 </span>
<span class="org-comment-delimiter">--</span>
<span class="org-comment-delimiter">--  </span><span class="org-comment">and type the log messages. </span>
<span class="org-comment-delimiter">--</span>
<span class="org-comment-delimiter">--</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> serveLog <span class="org-string">"10514"</span> plainHandler
<span class="org-haskell-constructor">From</span> 127.0<span class="org-haskell-operator">.</span>0.1<span class="org-haskell-constructor">:</span>49570<span class="org-haskell-constructor">:</span> syslogtcpserver<span class="org-haskell-operator">.</span>hs<span class="org-haskell-constructor">:</span> client connnected
<span class="org-haskell-constructor">From</span> 127.0<span class="org-haskell-operator">.</span>0.1<span class="org-haskell-constructor">:</span>49570<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Test</span> message <span class="org-haskell-operator">-</span> <span class="org-haskell-constructor">Fatal</span> kernel error
<span class="org-haskell-constructor">From</span> 127.0<span class="org-haskell-operator">.</span>0.1<span class="org-haskell-constructor">:</span>49570<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Application</span> server running <span class="org-haskell-constructor">OK</span><span class="org-haskell-operator">.</span>
</pre>
</div>


<p>
Running: syslogtcpserver with syslogclient:
</p>

<p>
syslogserver:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load <span class="org-string">"syslogtcpserver.hs"</span>
[1 <span class="org-haskell-keyword">of</span> 1] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( syslogtcpserver<span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> serveLog <span class="org-string">"10514"</span> plainHandler
</pre>
</div>

<p>
syslogclient:
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span class="org-haskell-operator">&gt;&gt;&gt;</span> 
<span class="org-haskell-operator">&gt;&gt;&gt;</span> <span class="org-haskell-constructor">:</span>load sylogtcpclient<span class="org-haskell-operator">.</span>hs 
[1 <span class="org-haskell-keyword">of</span> 2] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">SyslogTypes</span>      ( <span class="org-haskell-constructor">SyslogTypes</span><span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
[2 <span class="org-haskell-keyword">of</span> 2] <span class="org-haskell-constructor">Compiling</span> <span class="org-haskell-constructor">Main</span>             ( sylogtcpclient<span class="org-haskell-operator">.</span>hs<span class="org-haskell-operator">,</span> interpreted )
<span class="org-haskell-constructor">Ok</span><span class="org-haskell-operator">,</span> modules loaded<span class="org-haskell-constructor">:</span> <span class="org-haskell-constructor">SyslogTypes</span><span class="org-haskell-operator">,</span> <span class="org-haskell-constructor">Main</span><span class="org-haskell-operator">.</span>
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> openlog <span class="org-string">"localhost"</span> <span class="org-string">"10514"</span> <span class="org-string">"tcptest"</span>
 <span class="org-haskell-operator">***</span> <span class="org-haskell-constructor">Exception:</span> connect<span class="org-haskell-constructor">:</span> does not exist (<span class="org-haskell-constructor">Connection</span> refused)
<span class="org-haskell-operator">&gt;&gt;&gt;</span> 

<span class="org-haskell-operator">&gt;&gt;&gt;</span> sl <span class="org-haskell-operator">&lt;-</span> openlog <span class="org-string">"localhost"</span> <span class="org-string">"1514"</span> <span class="org-string">"tcptest"</span>
 <span class="org-haskell-operator">***</span> <span class="org-haskell-constructor">Exception:</span> connect<span class="org-haskell-constructor">:</span> does not exist (<span class="org-haskell-constructor">Connection</span> refused)
<span class="org-haskell-operator">&gt;&gt;&gt;</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Caio Rodrigues</p>
<p class="date">Created: 2016-03-22 Tue 04:54</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.5.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>